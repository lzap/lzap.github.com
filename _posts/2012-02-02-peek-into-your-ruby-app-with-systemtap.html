---
layout: post
title: Peek into your Ruby app with SystemTap
date: 2012-02-02
tags:
- ruby
- rails
- systemtap
---

<h1>{{ page.title }}</h1>
I already <a href="/2012/01/probing-ruby-apps-with-systemtap-in.html">wrote</a> about using SystemTap with Ruby. Today I want to extend the last example I linked at the very end of my article. It's a nice example script of Ruby "top" utility.<br /><br />Today I was investigating our <a href="http://www.katello.org">Katello</a> unit test codebase. We have over 1600 examples and the number is rising every day. The whole run is about seven minutes long. The utility gives very nice first look on the app showing the top Ruby calls. But there is one issue - it covers and shows lot of code. The output is unfiltered. But wait, there is the SystemTap!<br /><br />I was interested only in files that are in /usr/share/katello directory structure. Well, easy help. One simple if-statement and we only see what we want.<br /><br /><pre>cat ./trace-ruby-rails.stp<br />#!/usr/bin/stap <br /><br />global fn_calls;<br /><br />probe ruby.function.entry<br />{ <br />  if (isinstr(file, "katello")) fn_calls[pid(), file, methodname, line] <<< 1;<br />}<br /><br />probe timer.ms(4000) {<br />    ansi_clear_screen()<br />    printf("%6s %80s %6s %25s %6s\n",<br />           "PID", "FILENAME", "LINE", "FUNCTION", "CALLS")<br />    foreach ([pid, filename, funcname, lineno] in fn_calls- limit 15) {<br />        printf("%6d %80s %6d %25s %6d\n",<br />            pid, filename, lineno, funcname,<br />            @count(fn_calls[pid, filename, funcname, lineno]));<br />    }<br /><br />    delete fn_calls;<br />}</pre>Before you run this, make sure you make your terminal wide enough. Also I highly recommend to set MAXMAPENTRIES value which defaults to 2k which is not enough and you can run into problems. It's a simple:  <pre>stap -DMAXMAPENTRIES=10240 ./trace-ruby-rails.stp</pre>After I optimized our codebase I concentrated on Rails stack. Changing one lines shows you top calls from "active*" gems:  <pre>...<br />  if (isinstr(file, "/active")) fn_calls[pid(), file, methodname, line] <<< 1;<br />...</pre>By the way with some help of Ivan Neƒças we have found <a href="http://git.fedorahosted.org/git/?p=katello.git;a=commitdiff;h=0f46aabf51bcc4334b5b033eef5a8e15d1a0cb29">three</a> <a href="http://git.fedorahosted.org/git/?p=katello.git;a=commitdiff;h=3c7e99ffc7a75a6f400fa3a0c5ed30d85176fc3f">small</a> <a href="http://git.fedorahosted.org/git/?p=katello.git;a=commitdiff;h=d02643ae962407ab4354f1de6a2d2a1813baecdf">issues</a> which gave us 25 % boost. Not bad? I think I love SystemTap.