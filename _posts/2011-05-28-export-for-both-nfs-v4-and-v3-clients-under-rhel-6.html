---
layout: post
title: Export for both NFS v4 and v3 clients under RHEL 6
date: 2011-05-28
tags:
- nfsv3
- rhel6
- nvsv4
- nfs
---

<h1>{{ page.title }}</h1>
One of the new features in RHEL 6 is NFS version 4. It has a different concept and some administrators can be confused. I highly recommend to read RHEL 6 Storage Administration Guide or other documents related to NFSv4.<br /><br />The key change in NFSv4 is the concept of the root directory. To get things working for both v4 and v3 clients the most recommended way is to remount everything under one directory (we will create /exports for that). New clients will use relative paths and old clients full paths.<br /><br />In my example I am exporting /mnt/data directory, thus I am creating /exports directory with data directory in it, binding it there and configuring nfs and firewall.<br /><br /><i># mkdir /mnt/data</i><br /><i># mkdir -p /exports/data</i><br /><i><br /></i><br /><i># cat /etc/fstab | grep data</i><br /><i>/mnt/data      /exports/data      none       bind</i><br /><i><br /></i><br /><i># mount -a</i><br /><i><br /></i><br /><i># cat /etc/exports</i><br /><pre><i>/exports *(ro,async,no_subtree_check,insecure,fsid=0)<br />/exports/data 192.168.1.0/24(ro,sync,insecure,no_subtree_check,nohide)</i></pre><br />Now it's the time to configure firewall. Uncomment all the lines here:<br /><br /><i># grep -v '^#' /etc/sysconfig/nfs </i><br /><i>LOCKD_TCPPORT=32803</i><br /><i>LOCKD_UDPPORT=32769</i><br /><i>RQUOTAD_PORT=875</i><br /><i>MOUNTD_PORT=892</i><br /><i>STATD_PORT=662</i><br /><br />And add all the ports to the firewall config (tcp, udp, tcp, tcp in this order). Open portmapper tcp port 111 as well. You can use GUI/TUI for that, but I prefer config file edit:<br /><br /><i># sudo grep -E '\s(32803|32769|892|662|111)\s' /etc/sysconfig/iptables</i><br /><i>-A INPUT -m state --state NEW -m tcp -p tcp --dport 111 -j ACCEPT</i><br /><i>-A INPUT -m state --state NEW -m tcp -p tcp --dport 892 -j ACCEPT</i><br /><i>-A INPUT -m state --state NEW -m tcp -p tcp --dport 875 -j ACCEPT</i><br /><i>-A INPUT -m state --state NEW -m tcp -p tcp --dport 662 -j ACCEPT</i><br /><i>-A INPUT -m state --state NEW -m tcp -p tcp --dport 32803 -j ACCEPT</i><br /><i>-A INPUT -m state --state NEW -m udp -p udp --dport 32769 -j ACCEPT</i><br /><br /><b>Now, this is important</b>. Do not restart nfs using simple "restart" command. First of all bring all the services down:<br /><br /><i># service nfs stop</i><br /><i>#&nbsp;service nfslock&nbsp;stop</i><br /><i>#&nbsp;service rpcbind&nbsp;sto</i>p<br /><br />Now, restart iptables and bring all NFS services up in the following order.<br /><br /><i>#&nbsp;service iptables restart</i><br /><br /><i>#&nbsp;service rpcbind start</i><br /><br /><i>#&nbsp;service nfslock start</i><br /><i># service nfs start</i><br /><div><br /></div><br /><br />This is important because when you do "restart", nfs is usually running already by default and it won't show all errors. Make sure nfs, nfslock and rpcbind services are enabled after boot.<br /><br /><i># chkconfig nfs on</i><br /><br /><i># chkconfig nfslock on</i><br /><i># chkconfig rpcbind on</i><br /><br /><br />Test it:<br /><br /><i># showmount -e localhost</i><br /><br />We are almost there.&nbsp;NFSv4 clients must connect with relative address:<br /><br /><i># sudo mount -t nfs -o vers=4 server:/data /tmp/my/directory</i><br /><br />NFSv3 clients must use full address:<br /><br /><i># sudo mount -t nfs -o vers=3 server:/exports/data /tmp/my/directory</i><br /><br />Thank to our remount we are able to export any directory within the server.