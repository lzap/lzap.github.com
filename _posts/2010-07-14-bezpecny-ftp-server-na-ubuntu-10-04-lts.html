---
layout: post
title: Bezpečný FTP server na Ubuntu 10.04 LTS
date: 2010-07-14
tags:

---

<h1>{{ page.title }}</h1>
Potřeboval jsem rozjet zabezpečený FTP server pro jednoho uživatele. To znamená žádný anonymní přístup, přístup pouze pro lokálního uživatele. Jelikož byly nutné nějaké ty úpravy v konfiguračních souborech, tak se o to s vámi podělím.<br /><br />Použil jsem vsftpd server.<br /><br /><i>#&nbsp;sudo apt-get install openssl vsftpd</i><br /><br />Vytvořil jsem uživatele "upload" s domovským adresářem jinde než v /home.<br /><br /><i># useradd -d /mnt/bigdata/UPLOAD -s /bin/false upload</i><br /><i>#&nbsp;chown upload /mnt/bigdata/UPLOAD</i><br /><i>#&nbsp;passwd upload</i><br /><br />Nyní zapeklitý krok, který mě stál 20 minut bádání. Je potřeba vypnout kontrolu shellu pro uživatele. Toto se sice dá vypnout přímo v konfiguračním souboru vsftpd (check_shell=NO), ale pakliže vsftpd použivá PAM (v Ubuntu standardně ano), tak by to nefungovalo. Je potřeba zakomentovat řádek v souboru&nbsp;/etc/pam.d/vsftpd (ten poslední) takto:<br /><br /><br /><i># Standard behaviour for ftpd(8).</i><br /><i>auth &nbsp; &nbsp;required &nbsp; &nbsp; &nbsp; &nbsp;pam_listfile.so item=user sense=deny file=/etc/ftpusers onerr=succeed</i><br /><i># Note: vsftpd handles anonymous logins on its own. Do not enable pam_ftp.so.</i><br /><i># Standard pam includes</i><br /><i>@include common-account</i><br /><i>@include common-session</i><br /><i>@include common-auth</i><br /><i><b>#auth &nbsp; required &nbsp; &nbsp; &nbsp; &nbsp;pam_shells.so</b></i><br /><br /><br />Nyní můžeme přistoupit ke konfiguraci vsftpd. Standardní konfigurace až na jednu výjimku bude vyhovovat, takže nejprve zeditujeme soubor /etc/vsftpd.conf, projdeme si nastavení a nastavíme tyto hodnoty:<br /><br /><i># Vypnout anonymni ucet</i><br /><br /><i>anonymous_enable=NO</i><br /><br /><i># Zapnout lokalni ucty</i><br /><br /><i>local_enable=YES</i><br /><i># Zapis ano</i><br /><i>write_enable=YES</i><br /><i><br /></i><br /><i># Dalsi nastaveni dle libosti (neni nutne ale nic menit)</i><br /><i><br /></i><br /><i># Nasledujici radek ZAKOMENTUJTE</i><br /><i>#rsa_cert_file=/etc/ssl/private/vsftpd.pem</i><br /><br /><br />Nyní by FTP server měl fungovat lokálně s lokálními účty. Můžete to vyzkoušet příkazem telnet localhost 21 a zadáním příkazů USER xxx a PASS xxx. Poté dejte QUIT.<br /><br />Nyní nastavíme zabezpečení (SSL/TLS), jeho vynucení a nastavíme správné certifikáty (v default konfiguraci nebyla cesta k certifikátu správná):<br /><br /><br /><i># Certifikaty z Ubuntu LTS 10.04</i><br /><i>rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem</i><br /><i>rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key</i><br /><i><br /></i><br /><i># Aktivace SSL a nastaveni (pouze pro lokalni)</i><br /><i>ssl_enable=YES</i><br /><i>force_local_data_ssl=YES</i><br /><i>force_local_logins_ssl=YES</i><br /><i>ssl_tlsv1=YES</i><br /><i>ssl_sslv2=YES</i><br /><i>ssl_sslv3=YES</i><br /><i><br /></i><br /><i># Omezeni portu kvuli firewallu</i><br /><i>pasv_min_port=12000</i><br /><i>pasv_max_port=12100</i><br /><div><br /></div><br />Nemusíte žádné certifikáty generovat - použil jsem ty základní, které se automaticky generují při instalaci balíku openssl. Restart.<br /><br /><i># service vsftpd restart</i><br /><br />A je to. Nyní zbývá nastavit firewall, aby byl server dostupný z internetu. Může to být ADSL modem nebo WIFI AP, cokoli. Stačí vám přesměřovat na lokální server následující externí porty: 21, 12000-12100.<br /><br />Nyní se můžete připojit z internetu. Nezapomeňte použít TLS/SSL připojení (normální nebude fungovat) a také pasivní režim.