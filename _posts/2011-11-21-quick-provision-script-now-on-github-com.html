---
layout: post
title: Quick provision script now on github.com
date: 2011-11-21
tags:
- snap-guest
---

<h1>{{ page.title }}</h1>
<br />Snap-guest is a simple script for creating copy-on-write QEMU/KVM guests. I have put it on the <a href="https://github.com/lzap/snap-guest">github.com</a> recently. Patches are welcome.<br /><br /><b>Features</b><br /><br /><ul><li>creates qcow2 image based on different one</li><li>generates MAC address out of hostname</li><li>modifies network settings (MAC, hostname) for Fedora/Red Hat distros</li><li>creates and provisions guest using virt-install</li><li>nice cli interface</li></ul><br /><b>Requirements</b><br /><br /><ul><li>bash :-)</li><li>sed</li><li>python-virtinst</li><li>qemu-img</li><li>libguestfs-mount</li><li>vim (no, you don't really need it, but it's recommended :-)</li></ul><br /><b>How it works</b><br /><br />First of all you need to create base image using any method you want (e.g. virt-manager). It's recommended to use "base" string in the guest name (e.g. fedora-10-base or rhel4-base). The template image format can be qcow2 as well as different one (raw on LVM for example).<br /><br />Feel free to configure the base image according needs. It's recommended to install few packages like ntpd or acpid. The <a href="http://lukas.zapletalovi.com/2011/08/configure-red-hat-or-fedora-as-guest.html">following blogpost</a> contains more information regarding configuring base (or "template") guest.&nbsp;The only requirement is the hostname - it must be same as the base guest name. So if you name the VM fedora-10-base, hostname must be set the same.<br /><br />The usage is very easy then:<br /><blockquote class="tr_bq"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">usage: ./snap-guest options</span><br /><blockquote><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">Simple script for creating copy-on-write QEMU/KVM guests.<br />OPTIONS:<br />&nbsp; -h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Show this message<br />&nbsp; -l &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List avaiable images (with "base" in the name)<br />&nbsp; -a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List all images<br />&nbsp; -b [image] &nbsp; &nbsp; Base image name (template) - required<br />&nbsp; -t [image] &nbsp; &nbsp; Target image name (and hostname) - required<br />&nbsp; -n [network] &nbsp; Network settings (default: "network=default")<br />&nbsp; -m [MB] &nbsp; &nbsp; &nbsp; &nbsp;Memory (default: 800 MiB)<br />&nbsp; -c [CPUs] &nbsp; &nbsp; &nbsp;Number of CPUs (default: 1)<br />&nbsp; -p [path] &nbsp; &nbsp; &nbsp;Images path (default: /var/lib/libvirt/images/)<br />&nbsp; -d [domain] &nbsp; &nbsp;Domain suffix like "mycompany.com" (default: none)<br />&nbsp; -f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Force creating new guest (no questions)<br />EXAMPLE:<br />&nbsp; ./snap-guest -l<br />&nbsp; ./snap-guest -b fedora-17-base -t test-vm<br />&nbsp; ./snap-guest -b fedora-17-base -t test-vm2 -n bridge=br0 -d example.com<br />&nbsp; ./snap-guest -b rhel-6-base -t test-vm -m 2048 -c 4 -p /mnt/data/images</span></blockquote></blockquote>Snap-guest is a great tool for developing or testing. Provisioning new guest from a template is very fast (about 5-10 seconds).<br /><br /><b>Network</b><br /><br />The script modifies network settings in /etc/sysconfig directory (hostname and MAC address of the eth0). The MAC address is generated based on the hostname - the same hostname always gives the same address. Example:<br /><br /><ul><li>hostname a =&gt; mac 52:54:00:60:b7:25</li><li>hostname b =&gt; mac 52:54:00:3b:5d:5c</li><li>hostname a =&gt; mac 52:54:00:60:b7:25 (the same)</li></ul><br />This is great for testing - when you provision a box called let's say "test" and delete it, once it is provisioned again with the same name, DHCP will assign it the very same IP address.<br /><br /><b>Credits and license</b><br /><br />The script is distributed under public domain.<br /><br />Original script was written by Red Hat folks (Jason Dobies, Shannon Hughes, Mike McCune and others), I have slightly modified it, I was using it and after few improvements I decided to share it with the world.