---
layout: post
title: How to setup testing virtual network in libvirt
date: 2012-04-05
tags:
- libvirt
- network
- fedora
- rhel
- kvm
---

<h1>{{ page.title }}</h1>
<div><p>From the last week I am working on <a href="http://katello.org/">Katello</a> (systems management software for subscriptions and content) and <a href="http://theforeman.org/">Foreman</a> (system management software for provisioning and configuration) integration. I need to get everything running on one physical box using libvirt. I had to do three rounds until I finally configured everything correctly (actually doing my third round now). Anyway, let me share one libvirt-related idea that came to my mind today.</p><p>I need to have both Katello and Foreman and my own DHCP, DNS and TFTP services on the same network, but my hypervisor is on a corporate network. I use my libvirt mainly for development purposes and I have a bridged interface to get my development instances on the local LAN, so I can access it externally. This is widely used libvirt configuration I guess. I use my <a href="https://github.com/lzap/snap-guest">snap-guest</a> script to bring my instances quickly to life.</p><p>But for Katello-Foreman integration I need my own (virtual) network, therefore I have created new one using virt-manager: 192.168.100.0/24 with IPs from 192.168.100.10 to 192.168.100.200. One could reuse the default network called "network", but I have created new one since I will be disabling dnsmasq later on to let my own DHCP daemon into the play. And here comes the <i>big</i> idea.</p><p>This virtual network is behind NAT, so I cannot access guests externally. I was trying to realize how to solve this situation for few minutes, until I've heard the click in my head! All I need to do is to add another NIC, but bridged. So I did this using virt-manager, two mouse-clicks. And I realized I don't even need to restart the system, the new interface is immediately available from the bridged network. Now, I can access my development instances from the external network while having my own one with all the DHCP/DNS/TFTP and other provisioning stuff I am working on.</p><p>But if I'd need to access any port behind NAT (because of testing purposes or whatever), I created the following bash bit which creates NAT rules for all possible IP addresses for ssh (port 22), so I can access guests also via NAT. Feel free to replace port 22 with any other service you need to test against.</p><p><i>#!/bin/bash</i><br /><i># Create </i><i>ssh</i><i> forwards for </i><i>libvirt</i><i> virtual network 192.168.100.0 (10..200).</i><br /><i># Make sure to run this after </i><i>libvirtd</i><i> is started. This is not permanent,</i><br /><i># after firewall restart those rules are dropped.</i><br /><i>#</i><br /><i># Example: port 2242 -&gt; 192.168.100.42</i><br /><i># port 2299 -&gt; 192.168.100.99</i></p><p><i># Port (if &gt;63 use different scheme because of </i><i>TCP</i><i> port limitations)</i><br /><i>PORT=22</i><br /><i># Network part (only class C otherwise you need to change lines bellow)</i><br /><i>NET=192.168.100</i></p><p><i>for i in {10..200}; do</i><br /><i>iptables</i><i> -t </i><i>nat</i><i> -I </i><i>PREROUTING</i><i> -p </i><i>tcp</i><i> --</i><i>dport</i><i> $PORT$i -j </i><i>DNAT</i><i> --to-destination $NET.$i:$PORT</i><br /><i>done</i><br /><i>iptables</i><i> -I FORWARD -m state -d $NET.0/24 --state NEW,RELATED,ESTABLISHED -j ACCEPT</i></p><p>For the SSH example the following command lets you in:</p><p><i>ssh</i><i> -p2299 </i><i>your.bridged.hypervisor.hostname.com</i></p><p>I use NAT forwarding to get access to my testing guests which are created with foreman.</p><p>Update: I have added new option to snap-guest -k for second NIC, so you can start them with two. Also if you follow my two-NICs approach, make sure the bridged NIC has the default route! You want to go everything via bridged interface, while your virtual LAN is still accessible (route entry will be there). With red hat systems, you need to set DEFROUTE, PEERDNS and PEERROUTES settings in the ifcfg-eth* configurations properly (no for NAT interface, yes for bridged interface).</p><br /><p>If you must have both NAT and bridged interfaces accessible from outside (using the above trick), you will probably need <a href="http://kindlund.wordpress.com/2007/11/19/configuring-multiple-default-routes-in-linux/">two default routes</a>.</p></div>