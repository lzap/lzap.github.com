<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>How to setup testing virtual network in libvirt</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,libvirt,network,fedora,rhel,kvm"><meta property="og:url" content="https://blog.zapletalovi.com/posts/2012-04-05-how-to-setup-testing-virtual-network-in/"><meta property="og:type" content="website"><meta property="og:title" content="How to setup testing virtual network in libvirt"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="How to setup testing virtual network in libvirt"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="https://blog.zapletalovi.com/posts/2012-04-05-how-to-setup-testing-virtual-network-in/"><meta property="twitter:url" content="https://blog.zapletalovi.com/posts/2012-04-05-how-to-setup-testing-virtual-network-in/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=https://blog.zapletalovi.com/posts/2012-04-05-how-to-setup-testing-virtual-network-in/><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=https://blog.zapletalovi.com/css/dark.css><script src=https://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=https://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=https://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.zapletalovi.com><img src=https://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=https://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>How to setup testing virtual network in libvirt</h1><small role=doc-subtitle></small><p class=post-date>April 5, 2012</p><ul class=post-tags><li class=post-tag><a href=https://blog.zapletalovi.com/tags/libvirt>libvirt</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/network>network</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/fedora>fedora</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/rhel>rhel</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/kvm>kvm</a></li></ul></div><div class=post-content><p><div><p>From the last week I am working on <a href=http://katello.org/>Katello</a> (systems management software for subscriptions and content) and <a href=http://theforeman.org/>Foreman</a> (system management software for provisioning and configuration) integration. I need to get everything running on one physical box using libvirt. I had to do three rounds until I finally configured everything correctly (actually doing my third round now). Anyway, let me share one libvirt-related idea that came to my mind today.</p><p>I need to have both Katello and Foreman and my own DHCP, DNS and TFTP services on the same network, but my hypervisor is on a corporate network. I use my libvirt mainly for development purposes and I have a bridged interface to get my development instances on the local LAN, so I can access it externally. This is widely used libvirt configuration I guess. I use my <a href=https://github.com/lzap/snap-guest>snap-guest</a> script to bring my instances quickly to life.</p><p>But for Katello-Foreman integration I need my own (virtual) network, therefore I have created new one using virt-manager: 192.168.100.0/24 with IPs from 192.168.100.10 to 192.168.100.200. One could reuse the default network called "network", but I have created new one since I will be disabling dnsmasq later on to let my own DHCP daemon into the play. And here comes the <i>big</i> idea.</p><p>This virtual network is behind NAT, so I cannot access guests externally. I was trying to realize how to solve this situation for few minutes, until I've heard the click in my head! All I need to do is to add another NIC, but bridged. So I did this using virt-manager, two mouse-clicks. And I realized I don't even need to restart the system, the new interface is immediately available from the bridged network. Now, I can access my development instances from the external network while having my own one with all the DHCP/DNS/TFTP and other provisioning stuff I am working on.</p><p>But if I'd need to access any port behind NAT (because of testing purposes or whatever), I created the following bash bit which creates NAT rules for all possible IP addresses for ssh (port 22), so I can access guests also via NAT. Feel free to replace port 22 with any other service you need to test against.</p><p><i>#!/bin/bash</i><br><i># Create </i><i>ssh</i><i> forwards for </i><i>libvirt</i><i> virtual network 192.168.100.0 (10..200).</i><br><i># Make sure to run this after </i><i>libvirtd</i><i> is started. This is not permanent,</i><br><i># after firewall restart those rules are dropped.</i><br><i>#</i><br><i># Example: port 2242 -> 192.168.100.42</i><br><i># port 2299 -> 192.168.100.99</i></p><p><i># Port (if >63 use different scheme because of </i><i>TCP</i><i> port limitations)</i><br><i>PORT=22</i><br><i># Network part (only class C otherwise you need to change lines bellow)</i><br><i>NET=192.168.100</i></p><p><i>for i in {10..200}; do</i><br><i>iptables</i><i> -t </i><i>nat</i><i> -I </i><i>PREROUTING</i><i> -p </i><i>tcp</i><i> --</i><i>dport</i><i> $PORT$i -j </i><i>DNAT</i><i> --to-destination $NET.$i:$PORT</i><br><i>done</i><br><i>iptables</i><i> -I FORWARD -m state -d $NET.0/24 --state NEW,RELATED,ESTABLISHED -j ACCEPT</i></p><p>For the SSH example the following command lets you in:</p><p><i>ssh</i><i> -p2299 </i><i>your.bridged.hypervisor.hostname.com</i></p><p>I use NAT forwarding to get access to my testing guests which are created with foreman.</p><p>Update: I have added new option to snap-guest -k for second NIC, so you can start them with two. Also if you follow my two-NICs approach, make sure the bridged NIC has the default route! You want to go everything via bridged interface, while your virtual LAN is still accessible (route entry will be there). With red hat systems, you need to set DEFROUTE, PEERDNS and PEERROUTES settings in the ifcfg-eth* configurations properly (no for NAT interface, yes for bridged interface).</p><br><p>If you must have both NAT and bridged interfaces accessible from outside (using the above trick), you will probably need <a href=http://kindlund.wordpress.com/2007/11/19/configuring-multiple-default-routes-in-linux/>two default routes</a>.</p></div></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>