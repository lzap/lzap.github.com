<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Writing katello upgrade script</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora,katello"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2012-11-28-writing-katello-upgrade-script/"><meta property="og:type" content="website"><meta property="og:title" content="Writing katello upgrade script"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Writing katello upgrade script"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2012-11-28-writing-katello-upgrade-script/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2012-11-28-writing-katello-upgrade-script/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2012-11-28-writing-katello-upgrade-script/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Writing katello upgrade script</h1><small role=doc-subtitle></small><p class=post-date>November 28, 2012</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/katello>katello</a></li></ul></div><div class=post-content><p><p>With Katello, we deliver script upgrade-katello which enables users to upgrade
to the latest version interactively. Each upgrade is divided into several
steps. To see all of them, do:</p><pre><code># ls /usr/share/katello/install/upgrade-scripts/ -1
0050_start_qpid.sh
0099_preallocate_mongo.sh
0100_start_mongodb.sh
0110_migrate_pulp.sh
0200_start_httpd.sh
0385_remove_hornet_files.sh
0390_migrate_candlepin.sh
0400_start_tomcat.sh
0410_start_elasticsearch.sh
0700_start_foreman.sh
0710_migrate_katello.sh
0711_reindex_elastic.sh
0720_create_foreman_users.rb
0800_start_katello.sh
0805_start_katello_jobs.sh
0900_katello_configure.sh
</code></pre><p>Each step is just an linux executable, most of them are simple bash scripts
with shebang and header which is parsed by the katello-upgrade script:</p><pre><code># cat /usr/share/katello/install/upgrade-scripts/0390_migrate_candlepin.sh 
#!/bin/bash

#name: Migrate candlepin database
#apply: katello headpin
#run: always
#description:
#This step calls Candlepin cpdb utility to upgrade database schema
#in postgresql database to the latest version.

CANDLEPIN_HOME=${CANDLEPIN_HOME:-/usr/share/candlepin}

pushd $CANDLEPIN_HOME &gt;/dev/null
./cpdb --update 2&gt;&amp;1
ret_code=$?
popd &gt;/dev/null

exit $ret_code
</code></pre><p>Each script has a fancy name and description, which is presented to the user
either in interactive or non-interactive mode. Users can make decisions and
skip steps or completely suspend the upgrade process at any step if needed.</p><p>Katello can operate in two modes: &ldquo;katello&rdquo; and &ldquo;headpin&rdquo;. The latter is
something we call katello-light - it does not have all features installed. For
upgrades, we do not want to execute particular steps. We set the apply header
only to &ldquo;katello&rdquo; for those.</p><p>The last but not least is run header field. It indicates if we want to run the
step every upgrade, or only once. Scripts that has been executed are recorded
in a text file and never executed again if they was marked as &ldquo;once&rdquo;.</p><pre><code># cat /var/lib/katello/upgrade-history 
0099_preallocate_mongo.sh
0720_create_foreman_users.rb
</code></pre><p>Our installer, katello-configure, is written in Puppet. The first idea was to
write the installation process in pure Puppet, but after experiences with bad
ordering with older Puppet versions in our installer, we have decided to take
this simple approach. In future, we can consider rewriting our upgrade steps
as Puppet classes. Until then, we need to execute Puppet at the and of the
upgrade to re-deploy all configuration files that has been changed. We do it
twice, because our classes sometimes do not fully apply during the first run.</p><pre><code># cat /usr/share/katello/install/upgrade-scripts/0900_katello_configure.sh 
#!/bin/bash

#name: Reconfigure with katello-configure
#apply: katello headpin
#run: always
#description:
#This steps calls katello-configure twice to re-deploy configuration
#and restart services. Configuration files are replaced from erb templates
#which are distributed as part of katello-configure package. Make sure you
#have backup of all configuration files if you made any changes in it.

# do it twice - in rare cases configuration file changes needs two runs
katello-configure -b --answer-file=/etc/katello/katello-configure.conf &amp;&amp; \
  katello-configure -b --answer-file=/etc/katello/katello-configure.conf
</code></pre><p>Katello is easy to upgrade with this tool, it has nifty manual page and help
screen:</p><pre><code># katello-upgrade -h
Katello upgrade script
Usage: /sbin/katello-upgrade [options]
    -a, --autostop                   Automatically stop services using &quot;katello-service stop&quot;
    -y, --assumeyes                  Work non-intearactively and proceed without asking
    -n, --dryrun                     Prints the upgrade steps without modifying anything
    -q, --quiet                      Do not print anything on the stdout/stderr (only log)
        --describe                   Only describe all the upgrade steps without modifying anything
        --trace                      Print exception stacktrace on error
        --noservicecheck             Do not check if all services are stopped (use with care)
        --norootcheck                Disable check for root (use with care)
        --deployment=DEPLOYMENT      Force deployment mode (use with care)
    -h, --help                       Show this short summary
</code></pre><p>Go ahead and upgrade your Katello instance today!</p><h2 id=links>Links</h2><p>Katello: <a href=http://www.katello.org>http://www.katello.org</a>
Puppet: <a href=http://www.puppetlabs.com>http://www.puppetlabs.com</a></p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>