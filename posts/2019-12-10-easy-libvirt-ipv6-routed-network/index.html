<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Easy libvirt IPv6 routed network</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2019-12-10-easy-libvirt-ipv6-routed-network/"><meta property="og:type" content="website"><meta property="og:title" content="Easy libvirt IPv6 routed network"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Easy libvirt IPv6 routed network"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2019-12-10-easy-libvirt-ipv6-routed-network/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2019-12-10-easy-libvirt-ipv6-routed-network/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2019-12-10-easy-libvirt-ipv6-routed-network/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Easy libvirt IPv6 routed network</h1><small role=doc-subtitle></small><p class=post-date>December 10, 2019</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>This is a tutorial on how to create a routed IPv6 libvirt network for testing.
Having a &ldquo;default&rdquo; NAT network, create a new one called &ldquo;isolated&rdquo; as isolated
network (no upstream connectivity). Then create new VM with two network cards
both in &ldquo;default&rdquo; and &ldquo;isolated&rdquo; networks. I used CentOS 8.0 but this would
work with any distribution.</p><p>First off, create new account at <a href=https://www.tunnelbroker.net>https://www.tunnelbroker.net</a> and you will be
given an IPv6 network:</p><ul><li>Routed /64: 2001:db8:6f:443::/64</li><li>Routed /48: 2001:db8:59ef::/48</li><li>Server IPv6 Address: 2001:db8:6e:443::1/64</li><li>Client IPv6 Address: 2001:db8:6e:443::2/64</li></ul><p>Delete automatically created connections:</p><pre><code>	nmcli c delete enp1s0
	nmcli c delete &quot;Wired connection 1&quot;
</code></pre><p>Create upstream IPv4 connection, in my case it&rsquo;s DHCP. Upstream is the
interface connected to &ldquo;default&rdquo; NAT network:</p><pre><code>	nmcli con add type ethernet con-name upstream ifname enp1s0 ipv6.method ignore
</code></pre><p>For downstream (connected to &ldquo;isolated&rdquo; network) use the &ldquo;Routed /48&rdquo; subnet,
I&rsquo;ve decided to resevre 8 bits making it /64 creating subnet with &ldquo;cafe&rdquo;
octets. Make sure the connection is put into &ldquo;trusted&rdquo; zone when using
firewalld, otherwise create rules to allow traffic from downstream hosts.</p><pre><code>	nmcli c add con-name downstream type ethernet ifname enp2s0 ip6 2001:db8:59ef:cafe::1/64 connection.zone trusted
</code></pre><p>I haven&rsquo;t looked into how to create 6in4 tunnel via Network Manager, so I used
simple approach which can be found in Example Configurations on the
tunnelbroker.net site:</p><pre><code>	# cat /etc/rc.local 
	#!/bin/bash
	nm-online
	IP=$(nmcli -t -f IP4.ADDRESS con show upstream | cut -f2 -d: | cut -f1 -d/)
	ip tunnel add he-ipv6 mode sit remote 216.66.86.122 local $IP ttl 255
	ip link set he-ipv6 up
	ip addr add 2001:db8:6e:443::2/64 dev he-ipv6
	ip route add ::/0 dev he-ipv6

	cat &gt;/etc/resolv.conf &lt;&lt;EOF
	nameserver 2001:db8:20::2
	EOF

	sysctl -w net.ipv6.conf.all.forwarding=1

	touch /var/lock/subsys/local
</code></pre><p>Remember to make it executable:</p><pre><code>	# chmod +x /etc/rc.local
</code></pre><p>Run the script to create the tunnel and override the upstream DNS server. IPv6
communication should work now:</p><pre><code>	# ping6 ipv6.google.com
</code></pre><p>For my testing purposes, RADVD with DNS advertisment should be enough:</p><pre><code>	yum -y install radvd
</code></pre><p>Configuration is pretty simple, make sure to modify the subnet and interface
name:</p><pre><code>	# cat /etc/radvd.conf
	interface enp2s0
	{
					AdvSendAdvert on;
					AdvLinkMTU 1480;
					MaxRtrAdvInterval 300;
					prefix 2001:db8:59ef:cafe::/64
					{
									AdvOnLink on;
									AdvAutonomous on;
					};
					RDNSS 2001:db8:20::2 {
									AdvRDNSSLifetime 600;
					};
	};
</code></pre><p>Start the service, clients should be able to get IPv6 from the assigned subnet:</p><pre><code>	systemctl enable --now radvd
</code></pre><p>That&rsquo;s all actually, boot a VM in the &ldquo;isolated&rdquo; network. Most distributions
will attempt to acquire an IPv6 addres and everything should work as expected.</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>