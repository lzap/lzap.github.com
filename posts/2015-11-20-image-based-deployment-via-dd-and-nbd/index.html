<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Image based deployment via dd and nbd</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora,rhel,foreman"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2015-11-20-image-based-deployment-via-dd-and-nbd/"><meta property="og:type" content="website"><meta property="og:title" content="Image based deployment via dd and nbd"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Image based deployment via dd and nbd"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2015-11-20-image-based-deployment-via-dd-and-nbd/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2015-11-20-image-based-deployment-via-dd-and-nbd/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2015-11-20-image-based-deployment-via-dd-and-nbd/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Image based deployment via dd and nbd</h1><small role=doc-subtitle></small><p class=post-date>November 20, 2015</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/rhel>rhel</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/foreman>foreman</a></li></ul></div><div class=post-content><p><p>My train to Pilsen had about 300+ people onboard and apparently super-modern
ultra-fast WiFi technology can&rsquo;t handle that many people. At least when
administrator sets C class IPv4 network. People have cell phones, tablets and
laptops. It&rsquo;s no surprise that the DHCP server ran out of resources since I
see like 500+ devices around.</p><p>Hey, Leo Express, I am looking at you!</p><p>Luckily, not being able to connect to the internet I started hacking discovery
image. I was doing little research on image-based deployment. I already
created a small patch exposing all block devices via netcat. But since
OpenStack guys do deployments via iSCSI, I was wondering if I can do the same.</p><p>But first of all, let&rsquo;s test how raw image copy (via dd) compares to exposed
block device (iSCSI/NBD). Instead of iSCSI, I will test Network Block Device,
which is easier to configure and it is present in all Linux distributions,
including Fedora and RHEL (the client is actually in the kernel itself).</p><p>Target setup with NBD is very easy:</p><pre><code>dst# mkdir /etc/nbd-server/; cat &gt;/etc/nbd-server/config &lt;&lt;EOF
[generic]
[vdb]
exportname = /dev/XYZ
readonly = false
multifile = false
copyonwrite = false
EOF

dst# nbd-server -d

src# sudo modprobe nbd
src# sudo nbd-client dst-server -N vdb /dev/nbd1
</code></pre><p>Initial testing in the train involved testing on KVM instance. Direct transfer
of 1GB image with CirrOS (created with a command below) with block size of 1kB
was the fastest method indeed:</p><pre><code>src# time sudo dd if=/tmp/cirros.img of=/dev/nbd1 bs=1k
real    0m0.882s
</code></pre><p>Compressing the data speeds up things, lzop seems to be the fastest of course:</p><pre><code>dst# nc -l 1234 &gt; /dev/vdb
src# time sudo cat /tmp/cirros.img | ncat dst-server 1234
real    0m9.871s

dst# nc -l 1234 | gunzip &gt; /dev/vdb
src# time sudo cat /tmp/cirros.img | gzip -1 | ncat dst-server 1234
real    0m5.917s

dst# nc -l 1234 | lzop -d &gt; /dev/vdb
src# time sudo cat /tmp/cirros.img | lzop | ncat dst-server 1234
real    0m2.358s
</code></pre><p>Note that KVM/virtio is a special case, usually lzop is faster than raw data.
Now the remote block device approach:</p><pre><code>src# time sudo virt-builder cirros-0.3.1 --output /tmp/cirros.img --size 1G
real    0m20.352s
</code></pre><p>The same size, but over the (virtual) network:</p><pre><code>src# time sudo virt-builder cirros-0.3.1 --output /dev/nbd1
real    0m20.867s
</code></pre><p>I was surprised that the transfer was almost the same speed as local storage
(I was using virtio driver). I was expecting it to be little more slower. That
looks promising!</p><p>At home, I was able to do real testing on remote RHEL7 server over 1gig LAN
connection. For the record, I had to disable IPv6 to get nbd-server running
due to some bugs. For comparison, I created 10GB image. First, test the
fastest possible stream method:</p><pre><code>dst# nc -l 1234 | lzop -d &gt; /dev/XYZ
src# time sudo cat /tmp/cirros.img | lzop | ncat dst-server 1234
real    1m32.336s
</code></pre><p>Now, that is a difference. Let&rsquo;s test attached block storage. Locally first:</p><pre><code>src# time sudo virt-builder cirros-0.3.1 --output cirros.img --size 10240000000b
real    0m33.030s
</code></pre><p>The same size, but over the (gigabit) network:</p><pre><code>src# time sudo virt-builder cirros-0.3.1 --output /dev/nbd1
real    0m29.926s
</code></pre><p>I was scratching my head for few seconds until I realized why the attached
physical storage is actually faster. The local test was on my T430s laptop
with HDD in DVD bay while the server was Dell Precision T5400 with
end-consumer SATA drive. Still faster than the two inch laptop one.</p><p>Anyway, it looks like NBD performs well enough. I think this is a go to
implement this in foreman-discovery-image. Exporting volumes via NBD is an
easy task, the only work needs to be done on smart-proxy side to implement new
virt-builder plugin which will do the deployment.</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>