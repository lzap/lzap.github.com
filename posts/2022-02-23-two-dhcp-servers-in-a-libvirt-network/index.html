<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Two DHCP servers in a libvirt network</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2022-02-23-two-dhcp-servers-in-a-libvirt-network/"><meta property="og:type" content="website"><meta property="og:title" content="Two DHCP servers in a libvirt network"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Two DHCP servers in a libvirt network"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2022-02-23-two-dhcp-servers-in-a-libvirt-network/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2022-02-23-two-dhcp-servers-in-a-libvirt-network/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2022-02-23-two-dhcp-servers-in-a-libvirt-network/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Two DHCP servers in a libvirt network</h1><small role=doc-subtitle></small><p class=post-date>February 23, 2022</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>I write provisioning software that needs to integrate with DHCP servers. Libvirt is a great Linux virtual environment for development, but by default it runs its own DHCP server (dnsmasq). That is a very good feature for spawning ad-hoc VMs which get their IPs easily. But I want also to manage some VMs with my own DHCP server. How to do this?</p><p>It&rsquo;s possible to configure libvirt&rsquo;s dnsmasq to ignore pre-reserved host entries. This is how to do it:</p><pre><code>virsh net-destroy default
virsh net-undefine default
cat &gt;/tmp/network.xml &lt;&lt;EOF
&lt;network xmlns:dnsmasq='http://libvirt.org/schemas/network/dnsmasq/1.0'&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;forward mode='nat'/&gt;
  &lt;bridge name='virbr0' zone='trusted' stp='on' delay='0'/&gt;
  &lt;mac address='52:54:00:c9:00:01'/&gt;
  &lt;ip address='192.168.122.1' netmask='255.255.255.0'&gt;
    &lt;dhcp&gt;
      &lt;range start='192.168.122.2' end='192.168.122.254'/&gt;
      &lt;host mac='52:54:00:c9:00:10' ip='192.168.122.10'/&gt;
      &lt;host mac='52:54:00:c9:00:11' ip='192.168.122.11'/&gt;
      &lt;host mac='52:54:00:c9:00:12' ip='192.168.122.12'/&gt;
      &lt;host mac='52:54:00:c9:00:13' ip='192.168.122.13'/&gt;
      &lt;host mac='52:54:00:c9:00:14' ip='192.168.122.14'/&gt;
      &lt;host mac='52:54:00:c9:00:15' ip='192.168.122.15'/&gt;
      &lt;host mac='52:54:00:c9:00:16' ip='192.168.122.16'/&gt;
      &lt;host mac='52:54:00:c9:00:17' ip='192.168.122.17'/&gt;
      &lt;host mac='52:54:00:c9:00:18' ip='192.168.122.18'/&gt;
      &lt;host mac='52:54:00:c9:00:19' ip='192.168.122.19'/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
  &lt;dnsmasq:options&gt;
    &lt;dnsmasq:option value='dhcp-ignore=tag:!known'/&gt;
  &lt;/dnsmasq:options&gt;
&lt;/network&gt;
EOF
virsh net-define /tmp/network.xml &amp;&amp; rm -f /tmp/network.xml
virsh net-start default
virsh net-autostart default
</code></pre><p>I defined series of pre-allocated MAC addresses (10-19). VMs which I create with these MAC addresses will always get IP address from dnsmasq and they will be guaranteed to be the same. I use these VMs to deploy my the management software that includes DHCP server. Other VMs which do not have MAC addresses from the list are ignored by the dnsmasq therefore my own DHCP server can offer them IP addresses.</p><p>I tend to pre-allocated not only MAC addresses, but also VMs and their storage. I have two types, big and small:</p><pre><code>for X in s11 s13 s15 s17 s19; do lvcreate -L 8g -n $X vg_slow; done
for X in b10 b12 b14 b16 b18; do lvcreate -L 25g -n $X vg_slow; done
</code></pre><p>Then installing them is a matter of creating images:</p><pre><code>virt-install -n b10.local --memory 15500 --vcpus 2 --os-variant rhel8-unknown --graphics none --noautoconsole --boot bootmenu.enable=on,bios.useserial=on --serial pty --disk vol=vg_virt/b10.local --network default,mac=52:54:00:c8:00:10
virt-builder rhel-7.9 --output /dev/vg_virt/b10.local --root-password password:redhat --hostname b10.local --ssh-inject root:file:/home/lzap/.ssh/id_rsa.pub
</code></pre><p>Something like that, I just wanted to show the dhcp-ignore trick. Cheers!</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>