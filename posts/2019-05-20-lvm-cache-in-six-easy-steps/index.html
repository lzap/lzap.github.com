<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>LVM cache in six easy steps</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2019-05-20-lvm-cache-in-six-easy-steps/"><meta property="og:type" content="website"><meta property="og:title" content="LVM cache in six easy steps"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="LVM cache in six easy steps"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2019-05-20-lvm-cache-in-six-easy-steps/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2019-05-20-lvm-cache-in-six-easy-steps/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2019-05-20-lvm-cache-in-six-easy-steps/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>LVM cache in six easy steps</h1><small role=doc-subtitle></small><p class=post-date>May 20, 2019</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>This article shows how to quickly create LVM cache in six quick step, and how
to remove it properly. Before I start, little bit of warning: I do not
recommend using LVM cache on raw SSD devices. Due to <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1859149">bug in Fedora
30</a> my cachepool volume
was created with an incorrect cache chunk size which led to problems when I was
trying to remove cache volume from the pool after SSD died. Unfortunately, I
lost all my data since I used more complicated cachepool option.</p><p>Here is an advice: use LVM cache only on SSD RAID arrays, SSD chips do die
quickly without warning! Therefore it&rsquo;s a good fit for servers where use of LVM
is very likely. For desktop/laptop use I do recommend to use much more simple
<a href=https://www.kernel.org/doc/Documentation/bcache.txt>bcache</a> which is availble
in all modern distributions, it is hopefully stable enough and it was designed
from the day one to handle situations when SSD dies.</p><p>Before you stop reading, let me tell you that due to an extremely odd <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1708315">bug in
Fedora 30 GCC9</a> bcache was
corrupting data and I also lost data before I swithed to LVM cache. So nothing
is perfect. A friendly reminder: always backup your data no matter what.</p><p>Okay, so you want to use LVM cache. It&rsquo;s pretty simple. Let&rsquo;s assume there is a
(slow) HDD and (fast) NVMe SSD and the first primary partition on the slow
device (<code>sda1</code>) should be backed by cache created on the first secondary
partition of the fast device (<code>nvme0n1p5</code>). This is actually my workstation
setup, I keep my root filesystem, swap, boot and EFI partition as primary
without any caching or LVM.</p><pre><code>PV_SLOW=/dev/sda1
PV_FAST=/dev/nvme0n1p5
VG=vg_home
LV_SLOW=lv_home
LV_FAST=lv_home_cache
</code></pre><p>Here are the six steps. Physical volumes are created, volume group consisting
both volumes, then logical backing volume, then logical cache volume (pool) and
the final logical volume is converted (renamed) and the cache is built:</p><pre><code>pvcreate $PV_SLOW
pvcreate $PV_FAST
vgcreate $VG $PV_SLOW $PV_FAST
lvcreate -l 100%PVS -n $LV_SLOW $VG $PV_SLOW
</code></pre><p>Now, there are two options. Without cachepool which is more simple and I
recommend this over the other one:</p><pre><code>lvcreate -l 100%PVS -n $LV_FAST $VG $PV_FAST
lvconvert --type cache --cachevol $LV_FAST $VG/$LV_SLOW
</code></pre><p>Here is a more complicated cachepool option, only use this if you know what you
are doing:</p><pre><code>lvcreate --type cache-pool -l 100%PVS -n $LV_FAST $VG $PV_FAST
lvconvert --type cache --cachepool $LV_FAST $VG/$LV_SLOW
</code></pre><p>Few extra (hidden) logical volumes are created with suffixes <code>_cdata</code>, <code>_cmeta</code>
and <code>_corig</code>. I will not go into details because frankly I don&rsquo;t know much
about it but the important thing to understand is that the volume that shall be
used for mounting and working is named <code>$LV_SLOW</code> (<code>lv_home</code> in my example). So
to create a filesystem do something like:</p><pre><code>mkfs.ext4 $LV_SLOW
</code></pre><p>To remove LVM cache and go back to single origin (normal) logical
volume, just do the following:</p><pre><code>lvconvert --uncache $VG/$LV_SLOW
</code></pre><p>This will actually do the job of flushing the cache (if writeback was
set) and renaming logical volume back. Now you can access your data
using the very same logical volume (<code>$LV_SLOW</code>) which is cool.</p><p>WARNING: The &ldquo;uncache&rdquo; operation will fail if SSD is no longer available (e.g.
after data loss). Do not use <code>--force</code> option as this can possibly lead to data
loss.</p><p>That&rsquo;s all. Remember, backups, backups, backups&mldr;</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>