<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Probing Ruby apps with SystemTap in RHEL 6</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,ruby,fedora,rhel,systemtap"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2012-01-05-probing-ruby-apps-with-systemtap-in/"><meta property="og:type" content="website"><meta property="og:title" content="Probing Ruby apps with SystemTap in RHEL 6"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Probing Ruby apps with SystemTap in RHEL 6"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2012-01-05-probing-ruby-apps-with-systemtap-in/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2012-01-05-probing-ruby-apps-with-systemtap-in/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2012-01-05-probing-ruby-apps-with-systemtap-in/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Probing Ruby apps with SystemTap in RHEL 6</h1><small role=doc-subtitle></small><p class=post-date>January 5, 2012</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/ruby>ruby</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/rhel>rhel</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/systemtap>systemtap</a></li></ul></div><div class=post-content><p><p>There is one small'n'hidden feature of RHEL 6.2 that popped up recently as an enhancement errata (<a href=http://rhn.redhat.com/errata/RHSA-2011-1581.html>RHSA-2011-1581</a>). With this update, SystemTap probes have been added to the Ruby package. I was waiting for this feature, because at the time I was reading Aaron Patterson's <a href=http://tenderlovemaking.com/2011/12/05/profiling-rails-startup-with-dtrace/>excelent article</a>about Ruby probing, this was not possible in Fedora or Red Hat Enterprise Linux by default. I mean without compilation and installation of <a href=http://en.wikipedia.org/wiki/DTrace>DTrace</a> or SystemTap.</p><p>Imagine you have a Ruby application that has some performance issues on a production server and it's running RHEL 6.2 or newer. Now it is possible to perform very detailed probing using <a href=http://en.wikipedia.org/wiki/SystemTap>SystemTap</a>, which is similar technology to DTrace supported and developed by Red Hat.</p><p>It is possible to create probing scripts that are compiled as kernel modules and start them even on production servers without any change of running applications. It is possible to "look" into running applications and search for bottlenecks. Both DTrace and SystemTap are fantastic technologies.</p><p>Installation of SystemTap is easy and straightforward and for our purposes we do not need to install kernel devel and debug info packages.</p><pre><code># yum -y install systemtap systemtap-runtime ruby<br></code></pre><p>If you plan to trace kernel and other low level stuff, pay a visit the <a href=http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/6/html/SystemTap_Beginners_Guide/index.html>SystemTap Beginners Guide</a>, but this is quite enough for us.</p><p>Before we start, we will create a small Ruby example. In real situations you will be probing complex applications like Ruby on Rails or Sinatra. Let's call it <em>factorial.rb</em>.</p><pre><code># cat factorial.rb<br>def factorial n<br>  f = 1; for i in 1..n; f *= i; end; f<br>end<br>puts factorial 42<br></code></pre><p>The first example is the easiest, actually taken from the <a href=http://sourceware.org/systemtap/wiki/RubyMarker>SystemTap wiki</a>. It it able to print all Ruby method calls. Create a file called <em>calls.stp</em> with the following content:</p><pre><code># cat calls.stp <br>probe ruby.function.entry<br>{<br>  printf("%s =&gt; %s.%s in %s:%d\n", thread_indent(1),<br>         classname, methodname, file, line);<br>}<br>probe ruby.function.return<br>{<br>  printf("%s &lt;= %s.%s in %s:%d\n", thread_indent(-1),<br>         classname, methodname, file, line);<br>}<br></code></pre><p>Let's have some fun now.</p><pre><code># sudo stap calls.stp -c "ruby factorial.rb"<br>1405006117752879898543142606244511569936384000000000<br>     0 ruby(16160): =&gt; Module.method_added in factorial.rb:1<br>    13 ruby(16160): &lt;= Module.method_added in factorial.rb:1<br>     0 ruby(16160): =&gt; Object.factorial in factorial.rb:5<br>    25 ruby(16160):  =&gt; Range.each in factorial.rb:2<br>    61 ruby(16160):   =&gt; Fixnum.* in factorial.rb:2<br>    ... about twenty lines removed ...<br>   705 ruby(16160):   &lt;= Bignum.* in factorial.rb:2<br>   712 ruby(16160):  &lt;= Range.each in factorial.rb:2<br>   718 ruby(16160): &lt;= Object.factorial in factorial.rb:2<br>     0 ruby(16160): =&gt; Object.puts in factorial.rb:5<br>    20 ruby(16160):  =&gt; Bignum.to_s in factorial.rb:5<br>    38 ruby(16160):  &lt;= Bignum.to_s in factorial.rb:5<br>    53 ruby(16160):  =&gt; IO.write in factorial.rb:5<br>    74 ruby(16160):  &lt;= IO.write in factorial.rb:5<br>    81 ruby(16160):  =&gt; IO.write in factorial.rb:5<br>    99 ruby(16160):  &lt;= IO.write in factorial.rb:5<br>   106 ruby(16160): &lt;= Object.puts in factorial.rb:5<br></code></pre><p>Please note you have to run SystemTap under root account and also expect the first run to be a little bit slower, because SystemTap is compiling and inserting a kernel module under the hood.</p><p>By the way the big number (1405006117752879898543142606244511569936384000000000) is the actual output of our Ruby script. Yes, it's the world-famous 42! By the way it does not worth googling it - nothing special is found.</p><p>What about to count method calls now? I prepared a short script for that. If you are interested in the SystemTap syntax, google around or read whole <a href=http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/6/html/SystemTap_Beginners_Guide/index.html>Beginners Guide</a>.</p><pre><code># cat rubycount.stp <br>#!/usr/bin/stap <br><br>global fn_calls;<br><br>probe ruby.function.entry<br>{ <br>  fn_calls[classname, methodname] &lt;&lt;&lt; 1;<br>}<br><br>probe end {<br>  foreach ([classname, methodname] in fn_calls- limit 30) {<br>    printf("%dx %s.%s\n",<br>        @count(fn_calls[classname, methodname]),<br>        classname, methodname);<br>  }<br><br>  delete fn_calls;<br>}<br></code></pre><p>As you can see, it only counts all method calls and prints them when program ends. The output is much more useful.</p><pre><code># sudo stap rubycount.stp -c "ruby factorial.rb"<br>1405006117752879898543142606244511569936384000000000<br>21x Bignum.*<br>21x Fixnum.*<br>2x IO.write<br>1x Module.method_added<br>1x Range.each<br>1x Bignum.to_s<br>1x Object.puts<br>1x Object.factorial<br></code></pre><p>We have a <strong>catch</strong>! The need to optimize multiply methods :-)</p><p>Let's be serious again. Do you want to see more? I offer nothing more than a recommendation for you. Write your own scripts. Probe anything you want. You take a deep look on Ruby classes, methods, files, lines, garbage collector, exceptions and user defined probe points. SystemTap is very flexible and easy to use.</p><p>I have one more script for you, which can be downloaded from the <a href=http://sourceware.org/systemtap/wiki/RubyMarker>wiki</a>. It's called <em>rubyfuntop.stp</em> and it is a comfortable way of watching guts of Ruby processes. Something like "top", but with more information like methods and files. It is also a good example of live SystemTap technique. To run it just give it an exec flag:</p><pre><code># chmod +x rubyfuntop.stp<br># sudo ./rubyfuntop.stp<br></code></pre><p>Then execute the factorial in a different console.</p><p>For your information SystemTap for Ruby did not hit Fedora yet, I hope it will be part of Ruby 1.8 as well as Ruby 1.9 that is planned for Fedora 17. Have fun!</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>