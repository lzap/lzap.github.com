<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Jak stáhnout mnoho alb z Jamenda wgetem</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,skript,bash,jamendo"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2010-07-31-jak-stahnout-mnoho-alb-z-jamenda-wgetem/"><meta property="og:type" content="website"><meta property="og:title" content="Jak stáhnout mnoho alb z Jamenda wgetem"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Jak stáhnout mnoho alb z Jamenda wgetem"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2010-07-31-jak-stahnout-mnoho-alb-z-jamenda-wgetem/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2010-07-31-jak-stahnout-mnoho-alb-z-jamenda-wgetem/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2010-07-31-jak-stahnout-mnoho-alb-z-jamenda-wgetem/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Jak stáhnout mnoho alb z Jamenda wgetem</h1><small role=doc-subtitle></small><p class=post-date>July 31, 2010</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/skript>skript</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/bash>bash</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/jamendo>jamendo</a></li></ul></div><div class=post-content><p>Na serveru Jamendo.com je spoustu skvělé muziky, to se ví. S nákupem nové hračky Stanton SCS3 jsem se rozhodl, že si nějakou stáhnu ve velkém, abych mohl zkusit připravit nějaký set ve stylu deep house čistě z muziky licencované pod Creative Commons. Ale jak na to?<br><br>První idea byla poslouchat skladby v Rhytmboxu a poté je stahovat. Tento program nabízí možnost stáhnutí alba z Jamenda, nicméně jsem bohužel neuspěl. A to proto, že Rhythmbox stahuje pouze torrent soubory, které jsou v současné době neseedované. Situace je o něco lepší u méně kvalitního formátu MP3, ale 300kbps OGGy prostě nikdo neseeduje. Tudy cesta nepovede.<br><br>Druhá možnost byla ta nejjednodušší -- prostě alba "ručně" naklikat a stahovat v prohlížeči. Stáhl jsem takto tři a poté mě to přestalo bavit. Ani tudy cesta nevede. Co teď?<br><br>Jako třetí variantu jsem promýšlel použití specializovaného programu. I když je jich k dispozici <a href=http://developer.jamendo.com/en/wiki/JamendoApps>hned několik</a>, ani jeden mi nevyhovoval a nedělal to, co jsem chtěl. Totiž stahování alb v OGG formátu přímo přes HTTP.<br><br>Jelikož jsem včera musel dokončit v práci jeden úkol a vypil (na můj vkus) příliš mnoho kávy, ve dvě ráno, když jsem nemohl spát, jsem realizoval finální řešení. Vlastní skriptík, který udělá to, co chci.<br><br>Takže zopakuji svůj cíl - stáhnout všechna alba ve stylu House. Jamendo každý pracovní den vytváří <a href=http://developer.jamendo.com/en/wiki/NewDatabaseDumps>XML dump</a> své databáze tak, aby mohl být načítán přes internet do přehrávačů a jiných aplikací (např. Rhythmbox). Obsahuje veškeré potřebné informace jako jsou jména autorů, skladeb a alb. Jelikož jsem vygooglil, že odkaz na stažení alba je ve známém formátu, do skládanky mi stačilo pouze id alba. To v daném XML je. Skvělé.<br><br>Nejprve trošku odhalím, že jsem sestavil jediný příkaz, který provede stažení, rozbalení, extrakci dat a naformátování všech odkazů pro progra wget. Celý příkaz bude uveden na konci článku, nyní projdu jednotlivé části (ty jsou samy o sobě nefunkční!).<br><br>Takže krok první - stáhnutí XML dumpu, který je zazipovaný, jeho rozbalení.<br><br><i>wget -c -O - http://img.jamendo.com/data/dbdump_artistalbumtrack.xml.gz | gunzip | ...</i><br><br>Následuje extrakce podstatných dat - tedy identifikátorů těch alb, které jsou ve stylu house. Jamendo používá kromě taggování také standardní ID3 žánry. Na internetu jsem si našel, že house má číslo 35. Stejně tak si můžete <a href=http://www.multimediasoft.com/amp3dj/help/index.html?amp3dj_00003e.htm>najít svůj</a> oblíbený žánr, který byste chtěli stahovat a poslouchat lokálně.<br><br><i>... | xgrep -x "/JamendoData/Artists/artist/Albums/album[id3genre='35']/id" | ...</i><br><br>K tomuto příkazu jedna poznámka. Jedná se o <a href=http://cs.wikipedia.org/wiki/XPath>XPath</a> dotaz, což je jazyk pro adresaci částí XML dokumentů. Funguje to podobně, jako SQL jazyk u relačních databází. Háček byl v tom, že standardní linuxový příkaz "xpath" (Perl::XPath) nefungoval příliš dobře, protože rozbalený dump je sto mega velký. Prostě jsem se nedočkal výsledku.<br><br>Proto jsem musel nainstalovat z repozitáře mé distribuce prográmek xgrep, který umí také pracovat s XPath výrazy, ale je podstatně rychlejší. Na mém počítači zabrala tato část filtru pár desítek sekund.<br><br>Program xgrep filtruje tak, že nalezené XML elementy píše na jednotlivé řádky za sebe, mezi ně vkládá XML komentáře s informací o čísle řádku, ze kterého byl výběr proveden. Tyto komentáře jsem ve výstupu nechtěl, proto jsem tedy povolal ke zbrani program grep, a to hned ve dvou instancích. První provádí filtraci komentářů, ta druhá vyhází ze řádků nepotřebné elementy "id" a zůstane tak pouze číslo alba (na každém řádku). Jsme už blízko výsledku.<br><br><i>... | grep "<id>" | grep -e [0-9]* -o | ...</i><br><br>Jelikož adresa pro stažení je ve tvaru http://www.jamendo.com/get/album/ číslo_alba /album/archiverestricted/redirect/34662/?are=ogg3, tak jsem použil program sed, abych na začátek i konec každého řádku přidal text. Přiznávám, že jde o nešikovné řešení a budu rád, když se v komentářích podělíte o elegantnější. Já nejsem s awkem moc kamarád a jako zarytý vimař dost seduji. Slušná věta.<br><br><i>... | sed 's/[0-9]*/http:\/\/www.jamendo.com\/get\/album\/id\/album\/archiverestricted\/redirect\/\0\/?are=ogg3/g' | ...</i><br><br>Jak je vidět, musel jsem "eskejpovat". Pozor, je to celé jeden dlouhý řádek. No a výsledek? Ten uložíme do souboru.<br><br><i>... > list4download.txt</i><br><br>Hotovo. Takže v celé své kráse je to takhle. Pozor! Jeden řádek.<br><br><i>wget -c -O - http://img.jamendo.com/data/dbdump_artistalbumtrack.xml.gz | gunzip | xgrep -x "/JamendoData/Artists/artist/Albums/album[id3genre='35']/id" | grep "<id>" | grep -e [0-9]* -o | sed 's/[0-9]*/http:\/\/www.jamendo.com\/get\/album\/id\/album\/archiverestricted\/redirect\/\0\/?are=ogg3/g' > list4download.txt</i><br><br>Nádherné na tom je, že se všechno zpracovává paralelně. Postupně jak se stahuje velký (10 MB) zkomprimovaný XML soubor dochází k jeho postupné dekompresi a načítání xgrepem a dalšími programy. Je to vlastně bez čekání, čeká se pouze na to, než se soubor stáhne.<br><br>To ale není všechno. Máme sice seznam odkazů a já jsem si jist, že víte, co s ním. Je tu druhý háček - Jamendo omezuje stahovače. Tedy ty, co nadměrně zatěžují jejich servery. Pokud byste nyní spustili wget a začli hned stahovat, po několika albech by server začal vracet chybu 404 (Not Found), což pro většinu stahovacích programů (včetně wgetu) znamená stopku. Pro takový program prostě stahovaný soubor neexistuje, takže v seznamu pokračuje dále. Server odpoví stejným způsobem na ostatní soubory a wget do pár sekund skončí s tím, že stahování je hotovo. Aby ne - dané soubory na serveru totiž "nejsou".<br><br>Proto se musí na Jamendo šetrně. Doporučuji tři věci: čekání mezi stahováním souborů (parametr -w a --random-wait), omezení rychlosti stahování (přepínač -limit-rate=xxx) a maskování wgetu jako standardní prohlížeč (-U a další).<br><br>Proto nabízím příkaz, který zaručeně s Jamendem funguje.<br><br><i>wget --user-agent="Opera/9.70 (Linux i686 ; U; en) Presto/2.2.0" --header="Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5" --header="Accept-Language: en-us,en;q=0.5" --header="Accept-Encoding: gzip,deflate" --header="Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7" --header="Keep-Alive: 300" -c -t0 -N -w 45 --random-wait --limit-rate=800k -i list4download.txt</i><br><br>Pokud stahování spouštíte na serveru, doporučuji použití programů screen nebo nohup, abyste se mohli odhlásit a stahování pokračovalo i nadále. V tomto příkazu je maskování jako Opera, navazování spadlých připojení do nekonečna, nestahování již stažených a hotových souborů, čekání mezi stahováním od 30 do 90 sekund (náhodně, zhruba) a omezení rychlosti na 800 kB.</p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>