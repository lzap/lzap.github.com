<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Booting 3.8+ kernels on Marwell Kirkwood ARM Zyxel NSA 310</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora,arm"><meta property="og:url" content="https://blog.zapletalovi.com/posts/2013-03-17-booting-38-kernels-on-marwell-kirkwood-arm-zyxel-nsa-310/"><meta property="og:type" content="website"><meta property="og:title" content="Booting 3.8+ kernels on Marwell Kirkwood ARM Zyxel NSA 310"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Booting 3.8+ kernels on Marwell Kirkwood ARM Zyxel NSA 310"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="https://blog.zapletalovi.com/posts/2013-03-17-booting-38-kernels-on-marwell-kirkwood-arm-zyxel-nsa-310/"><meta property="twitter:url" content="https://blog.zapletalovi.com/posts/2013-03-17-booting-38-kernels-on-marwell-kirkwood-arm-zyxel-nsa-310/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=https://blog.zapletalovi.com/posts/2013-03-17-booting-38-kernels-on-marwell-kirkwood-arm-zyxel-nsa-310/><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=https://blog.zapletalovi.com/css/dark.css><script src=https://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=https://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=https://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.zapletalovi.com><img src=https://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=https://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Booting 3.8+ kernels on Marwell Kirkwood ARM Zyxel NSA 310</h1><small role=doc-subtitle></small><p class=post-date>March 17, 2013</p><ul class=post-tags><li class=post-tag><a href=https://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/fedora>fedora</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/arm>arm</a></li></ul></div><div class=post-content><p><p>Zyxel NSA 3xx are excellent and cheap NAS devices and finally support for
model NSA 310 landed in Linus tree in the 3.8 version. Good news, but this
Marwell Kirkwood-based ARM device is using DTS (Device Tree). I had no
experiences with compiling DTS kernels, until this night.</p><p>So the Device Tree, or The Flattened Device Tree, (FDT) is a data structure
for describing the hardware in a system. It is a derived from the device tree
format used by Open Firmware to encapsulate platform information and convey it
to the operating system. The operating system uses the FDT data to find and
register the devices in the system. (Taken from
<a href=http://elinux.org/Device_Trees>http://elinux.org/Device_Trees</a>)</p><p>Simply put, Device Tree helps us to boot various (ARM) hardware without need
of recompiling kernel for each device. The basic idea is to compile
information about the hardware (DTS is the source file, DTB is binary compiled
data structure) into the kernel and to integrate bootloader with it so it is
able to pick up the relevant DTB and continue booting the kernel.</p><p>The issue with NSA 310 is it&rsquo;s bootloader does not support Device Tree.
Fortunately, there is an option to tell the linux kernel to load DTB from end
address using an option and concatenating the DTB info to it.</p><p>Let&rsquo;s do it. First of all, get a 3.8+ kernel and see what we can do:</p><pre><code># make help
...
Architecture specific targets (arm):
* zImage        - Compressed kernel image (arch/arm/boot/zImage)
  Image         - Uncompressed kernel image (arch/arm/boot/Image)
* xipImage      - XIP kernel image, if configured (arch/arm/boot/xipImage)
  uImage        - U-Boot wrapped zImage
  bootpImage    - Combined zImage and initial RAM disk
                  (supply initrd image via make variable INITRD=&lt;path&gt;)
* dtbs          - Build device tree blobs for enabled boards
  install       - Install uncompressed kernel
  zinstall      - Install compressed kernel
  uinstall      - Install U-Boot wrapped compressed kernel
                  Install using (your) ~/bin/installkernel or
                  (distribution) /sbin/installkernel or
                  install to $(INSTALL_PATH) and run lilo
...
</code></pre><p>There are some patches in the testing arm repositories that adds new make
targets that does the trick for you, so you can do something like:</p><pre><code>make dtbuImage.kirkwood-nsa310
</code></pre><p>to get DTB-enhanced kernel for uImage directly. This hasn&rsquo;t been merged into
the Linus tree yet. We are going to do this manually now. First of all,
configure your kernel. Make sure you have NSA 310 support and DTB loading:</p><pre><code># grep &quot;ARM_APPENDED_DTB|NSA&quot; .config
CONFIG_ARM_APPENDED_DTB=y
CONFIG_MACH_NSA310_DT=y
</code></pre><p>As well as other ARM options. Then compile the kernel:</p><pre><code># make zImage
...
Kernel: arch/arm/boot/zImage is ready
</code></pre><p>Then we will compile our NSA 310 DTS into DTB binary representation:</p><pre><code># make dtbs
</code></pre><p>The above target creates kirkwood-nsa310.dtb along with other kirkwood files
(and all of those you have enabled in your configuration). Now we need to
concatenate it into our kernel:</p><pre><code># cat arch/arm/boot/zImage arch/arm/boot/dts/kirkwood-nsa310.dtb &gt; /tmp/X
# mv /tmp/X arch/arm/boot/zImage
</code></pre><p>We have changed zImage, but we can continue building our u-boot image because
the file is newer and GNU make will have no problems with that. So let&rsquo;s
create the final u-boot kernel:</p><pre><code># make uImage
...
Image Type:   ARM Linux Kernel Image (uncompressed)
Data Size:    3684110 Bytes = 3597.76 kB = 3.51 MB
Load Address: 00008000
Entry Point:  00008000
Image arch/arm/boot/uImage is ready
</code></pre><p>We are done, copy your kernel to the final destination:</p><pre><code># cp arch/arm/boot/uImage /boot/uImage-nsa310
</code></pre><p>To boot it just do something like this in your u-boot environment:</p><pre><code>ide reset; ext2load ide 0:1 0x800000 /uImage-nsa310; bootm 0x800000
</code></pre><p>This depends on where you boot your device from. I will maybe create some
other articles about booting Fedora on this device. What I want to focus on is
creating my own setup on USB flash drive and F2FS.</p><p>If you googled my article, please drop me a line bellow. Take care!</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>