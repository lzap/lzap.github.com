<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>EFI in QEMU KVM on Fedora 20</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="https://blog.zapletalovi.com/posts/2014-09-30-efi-in-qemu-kvm-on-fedora-20/"><meta property="og:type" content="website"><meta property="og:title" content="EFI in QEMU KVM on Fedora 20"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="EFI in QEMU KVM on Fedora 20"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="https://blog.zapletalovi.com/posts/2014-09-30-efi-in-qemu-kvm-on-fedora-20/"><meta property="twitter:url" content="https://blog.zapletalovi.com/posts/2014-09-30-efi-in-qemu-kvm-on-fedora-20/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=https://blog.zapletalovi.com/posts/2014-09-30-efi-in-qemu-kvm-on-fedora-20/><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=https://blog.zapletalovi.com/css/dark.css><script src=https://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=https://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=https://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.zapletalovi.com><img src=https://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=https://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>EFI in QEMU KVM on Fedora 20</h1><small role=doc-subtitle></small><p class=post-date>September 30, 2014</p><ul class=post-tags><li class=post-tag><a href=https://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>Last sprint, I was working on EFI PXE booting support for Foreman. Although I
have a EFI-compatible PC in the house, I wanted a stable environment for
development and testing. Virtualized, of course.</p><p>The best option is KVM/QEMU/libvirt triple which I use for regular Foreman
development. I started googling around and spent a day modifying my
distribution package. It did not work well. And then I stumbled upon familiar
name, Laszlo Ersek from Red Hat, who helped me getting this rolling.</p><h2 id=qemu-with-efi>QEMU with EFI</h2><p>To get EFI working under QEMU, one needs 2.1.1+ version with modified BIOS.
Since I already almost destroyed configuration of the QEMU from Fedora 20 (had
to reinstall the packages), I was guided to install from sources:</p><pre><code>wget http://wiki.qemu-project.org/download/qemu-2.1.1.tar.bz2
tar bla bla
yum -y install spice-server-devel spice-protocol SDL-devel
./configure --target-list=x86_64-softmmu --enable-spice \
    --prefix=/opt/qemu-2.1.1 --enable-debug --disable-gtk
make install
chown root:root /opt/qemu-2.1.1/libexec/qemu-bridge-helper
chmod u=rwxs,g=rx,o=rx /opt/qemu-2.1.1/libexec/qemu-bridge-helper
echo 'allow virbr0' &gt; /opt/qemu-2.1.1/etc/qemu/bridge.conf
</code></pre><p>Having stable version installed in a separate tree (which keeps your laptop
clean along smile on your face), one needs to download and install BIOS and
EFI firmware. This is important step - for PXE booting, latest nightly builds
are needed. Fortunately, for Fedora/Red Hat users, there is a repo out there
with latest and greatest build. Do not worry, those packages are compatible
with Fedora and won&rsquo;t overwrite/upgrade anything. You can install them next to
the official QEMU BIOS:</p><pre><code>sudo wget https://www.kraxel.org/repos/firmware.repo -O \
    /etc/yum.repos.d/kraxel-qemu-firmare.repo
yum install edk2.git-ovmf-x64
</code></pre><p>This guy installs into /usr/share/edk2.git along with some dependencies which
are also compiled from git (SeaBIOS for legacy EFI mode, NIC drivers and so
on).</p><p>Now, the <em>hardest</em> part. Since libvirt currently lacks UEFI support, we need
to work directly with QEMU. I&rsquo;d like to thank Laszlo for constructing me this
script which sets up things correctly:</p><pre><code>#!/bin/bash
OVMF_BINARY=/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd
VARSTORE_TEMPLATE=/usr/share/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd
QEMU_ROOT=/opt/qemu-2.1.1

# create fresh variable store
cp $VARSTORE_TEMPLATE /tmp/guest-vars.fd

# run qemu
$QEMU_ROOT/bin/qemu-system-x86_64 \
  -M pc-i440fx-2.1 \
  -enable-kvm \
  -m 900 \
  -drive unit=0,if=pflash,format=raw,readonly,file=$OVMF_BINARY \
  -drive unit=1,if=pflash,format=raw,file=/tmp/guest-vars.fd \
  -global isa-debugcon.iobase=0x402 \
  -debugcon file:/tmp/guest.ovmf.log \
  -monitor stdio \
  -device piix3-usb-uhci -device usb-tablet \
  -netdev bridge,id=net0,br=virbr0,helper=$QEMU_ROOT/libexec/qemu-bridge-helper \
  -device virtio-net-pci,netdev=net0,romfile=,bootindex=0 \
  -device qxl-vga
</code></pre><p>You can run this script as regular user the only part requiring root access is
the networking one (bridge helper) and that has suid bit set. The VM will be
connected to the &ldquo;default&rdquo; libvirt virtual NAT network (virbr0) where you can
set up your PXE environment and start playing with EFI PXE booting.</p><h2 id=pxelinux-and-foreman>PXELinux and Foreman</h2><p>In this second part of my blog entry, I want to share some news about Foreman
support. Since Foreman ships with templates set for PXELinux by default, I
wanted to keep on this path.</p><p>Apparently syslinux 5.x does not have EFI support and syslinux 6.02 did not
work for me. So I decided to compile 6.03 from sources which did not work
either. Luckily, folks on the IRC channel recommended to use 6.03-pre20
version which worked like a charm:</p><pre><code>https://www.kernel.org/pub/linux/utils/boot/syslinux/Testing/6.03/syslinux-6.03-pre20.tar.gz
</code></pre><p>The following files need to be extracted into tftpboot/efi64 directory:</p><pre><code>syslinux.efi
chain.c32
ldlinux.e64
libutil.c32
menu.c32
</code></pre><p>Also I created <em>relative</em> symlinks (TFTP runs in chroot usually) for
configuration and kernels:</p><pre><code>boot -&gt; ../boot
pxelinux.cfg -&gt; ../pxelinux.cfg
</code></pre><p>You can do the same with 32bit arch. But that&rsquo;s pretty much it!</p><p>DHCP daemon configuration is straighforward and the best approach is only to
hand over EFI PXELinux to DHCP clients which reports as EFI-compatible. You
need something like (192.168.100.0 network with Foreman running on .2):</p><pre><code># ... snippet ...

option arch code 93 = unsigned integer 16;

subnet 192.168.100.0 netmask 255.255.255.0 {
    pool {
        range 192.168.100.10 192.168.100.200;
    }

    option subnet-mask 255.255.255.0;
    option routers 192.168.100.1;

    class &quot;pxeclients&quot; {
        match if substring (option vendor-class-identifier, 0, 9) = &quot;PXEClient&quot;;
        next-server 192.168.100.2;

        if option arch = 00:07 {
            filename &quot;efi/syslinux.efi&quot;;
        } else if option arch = 00:06 {
            filename &quot;efi32/syslinux.efi&quot;;
        } else {
            filename &quot;pxelinux/pxelinux.0&quot;;
        }
    }
}
</code></pre><p>Similarly you can use Grub, you need to copy EFI binary and create
configuration file. This is covered in RHEL6 (<a href=https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/s1-netboot-pxe-config-efi.html>1</a>) and RHEL7 (<a href=https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Installation_Guide/chap-installation-server-setup.html#sect-network-boot-setup-uefi>2</a>)
documentation.</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>