<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Setup a SystemTap permission change trap</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora,rhel,systemtap"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2012-04-17-setup-systemtap-permission-change-trap/"><meta property="og:type" content="website"><meta property="og:title" content="Setup a SystemTap permission change trap"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Setup a SystemTap permission change trap"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2012-04-17-setup-systemtap-permission-change-trap/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2012-04-17-setup-systemtap-permission-change-trap/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2012-04-17-setup-systemtap-permission-change-trap/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Setup a SystemTap permission change trap</h1><small role=doc-subtitle></small><p class=post-date>April 17, 2012</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/rhel>rhel</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/systemtap>systemtap</a></li></ul></div><div class=post-content><p>We were investigating issue today - something - some process - have changed permission of a very important file in one of our Katello testing installations. We only know it happened over the night. The task is to catch the instigator. We can use SystemTap for that. <a href=http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/6/html/SystemTap_Beginners_Guide/index.html>Prepare our environment</a>:<br><br><i>yum -y install systemtap systemtap-runtime kernel-debuginfo-`uname -r` kernel-debuginfo-common-`uname -i`-`uname -r` kernel-devel-`uname -r`</i><br><br>Our target file will be /test:<br><br><i>touch /test</i><br><br>Let's get its inode:<br><br><i>ls -i /test<br>274</i><br><br>Using "mount" found the device the file resides on and find it's major and minor numbers: In my case it's:<br><br><i>ll /dev/md-0<br>brw-rw----. 1 root disk 253, 0 Apr 17 10:23 /dev/dm-0</i><br><br>Now create the following file:<br><br><pre>cat filechange.stp<br>#!/usr/bin/env stap<br>global ATTR_MODE = 1<br>probe kernel.function("setattr_copy")!,<br>      kernel.function("generic_setattr")!,<br>      kernel.function("inode_setattr") {<br>  dev_nr = $inode->i_sb->s_dev<br>  inode_nr = $inode->i_ino<br><br>  if (dev_nr == MKDEV($1,$2) # major/minor device<br>      && inode_nr == $3<br>      && $attr->ia_valid & ATTR_MODE)<br>    printf ("%d %s(%d) %s 0x%x/%u %o %d\n",<br>      gettimeofday_us(), execname(), pid(), probefunc(),<br>      dev_nr, inode_nr, $attr->ia_mode, uid())<br>}</pre><br>And run it in a screen session or something:<br><br><i>stap -v filechange.stp 253 0 274</i><br><br>After some time...<br><br><i>1334676922011223 chmod(6157) generic_setattr 0xfd00000/274 100600 0</i><br><br>...<b>BUSTED</b>! The fist one is timestamp, the second one is process name(pid).</p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>