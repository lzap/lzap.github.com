<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Use btrfs compression in Fedora 33</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="https://blog.zapletalovi.com/posts/2021-02-21-use-btrfs-compression-in-fedora-33/"><meta property="og:type" content="website"><meta property="og:title" content="Use btrfs compression in Fedora 33"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Use btrfs compression in Fedora 33"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="https://blog.zapletalovi.com/posts/2021-02-21-use-btrfs-compression-in-fedora-33/"><meta property="twitter:url" content="https://blog.zapletalovi.com/posts/2021-02-21-use-btrfs-compression-in-fedora-33/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=https://blog.zapletalovi.com/posts/2021-02-21-use-btrfs-compression-in-fedora-33/><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=https://blog.zapletalovi.com/css/dark.css><script src=https://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=https://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=https://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.zapletalovi.com><img src=https://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=https://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Use btrfs compression in Fedora 33</h1><small role=doc-subtitle></small><p class=post-date>February 21, 2021</p><ul class=post-tags><li class=post-tag><a href=https://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>Btrfs have been available in Fedora for quite some time and starting from
Fedora 33, new installations of Workstation edition use it by default. Btrfs is
pretty capable file system with lots of options, let&rsquo;s take a look on one
aspect: transparent per-file compression.</p><p>There&rsquo;s little bit of misunderstanding how this works and some people recommend
to mount with <code>compress</code> option. This is actually not necessary and I would
actually strongly suggest NOT to use this option. See, this option makes btrfs
to attempt to compress all files that are being written. If the beginning of a
file cannot be effectively compressed, it&rsquo;s marked as &ldquo;not for compression&rdquo; and
this is never attempted again. This can be even forced via a different option.
This looks nice on paper.</p><p>The problem is, not all files are good candidates for compression. Compression
takes time and it can dramatically worsen performance, things like database
files or virtual machine images should never be compressed. Performance of
libvirt/KVM goes terribly down by order of magnitude if an inefficient backing
store is used (qcow2).</p><p>I suggest to keep the default mount options Anaconda installer deploys, note
there is none related to compression. Instead, use per-file (per-directory)
feature of btrfs to mark files and directories to be compressed. A great
candidate is <code>/usr</code> which contains most of the system including binaries or
documentation.</p><p>One mount option is actually useful which Anaconda does not set by default and
that is <code>noatime</code>. Writing access times for copy on write file system can be
very inefficient. Note this option implies <code>nodiratime</code> so it&rsquo;s not necessary
to set both.</p><p>To enable compression for <code>/usr</code> simply mark this directory to be compressed.
There are several compression algorithms available: zlib (slowest, best ratio),
zstd (decent ratio, good performance) and lzo (best performance, worse ratio).
I suggest to stick with zstd which lies in the middle. There are also
compression level options, unfortunately the utility does not allow setting
those at the time of writing. Luckily, the default level (3) is reasolable.</p><pre><code># btrfs property set /usr compression zstd
</code></pre><p>Now, btrfs does not immediately start compressing contents of the directory.
Instead, everytime a file is written data in those blocks is compressed. To
explicitly compress all files recursively, do this:</p><pre><code># btrfs filesystem defragment -r -v -czstd /usr
</code></pre><p>Let&rsquo;s find out how much space have we saved:</p><pre><code># compsize /usr
Processed 55341 files, 38902 regular extents (40421 refs), 26932 inline.
Type       Perc     Disk Usage   Uncompressed Referenced  
TOTAL       50%      1.1G         2.2G         2.3G       
none       100%      337M         337M         338M       
zstd        42%      844M         1.9G         1.9G  
</code></pre><p>Exactly half of space is saved on a standard installation of Fedora 33 Server
when <code>/usr</code> is compressed using zstd algorithm with the default level. Note
some files are not compressed, these are too small files when it does not make
any sense (a block would be used anyway). Not bad.</p><p>To disable compression perform the following command:</p><pre><code># btrfs property set /usr compression &quot;&quot;
</code></pre><p>Unfortunately, at the time of writing it is not possible to force decompression
of a directory (or files), there is no defragment command to do this. If you
really need to do this, create a script which reads and writes all files but be
careful.</p><p>Keep in mind the <code>btrfs property</code> command will <em>force</em> all files to be
compressed, even if they do not compress well. This will work pretty well for
<code>/usr</code> just make sure there is no 3rd party software installed there writing
files. There is also a way to mark files for compression and if they don&rsquo;t
compress well btrfs could give up on it. You can do that by setting <code>chattr +c</code>
on files or directories. Unfortunately, you can&rsquo;t set compression algorithm
that way - btrfs will default to slower <code>zlib</code>.</p><p>Remember: Do not compress everything, specifically directory <code>/var</code> should
definitely not be compressed. If you happened to accidentally mark files
within <code>/var</code> to be compressed, you can fix this with:</p><pre><code># find /var -exec btrfs property set {} compression &quot;&quot; \;
</code></pre><p>Again, this will only mark them not to be compressed, it&rsquo;s currently not
possible to explicitly decompress them. Use the <code>compsize</code> utility to find out
how much of data is still compressed.</p><p>That&rsquo;s all for today, I will probably sharing some more btrfs posts.</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>