<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>How to TRIM your encrypted SSD in Fedora 19</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="https://blog.zapletalovi.com/posts/2013-11-14-how-to-trim-your-ssd-in-fedora-19/"><meta property="og:type" content="website"><meta property="og:title" content="How to TRIM your encrypted SSD in Fedora 19"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="How to TRIM your encrypted SSD in Fedora 19"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="https://blog.zapletalovi.com/posts/2013-11-14-how-to-trim-your-ssd-in-fedora-19/"><meta property="twitter:url" content="https://blog.zapletalovi.com/posts/2013-11-14-how-to-trim-your-ssd-in-fedora-19/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=https://blog.zapletalovi.com/posts/2013-11-14-how-to-trim-your-ssd-in-fedora-19/><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=https://blog.zapletalovi.com/css/dark.css><script src=https://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=https://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=https://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.zapletalovi.com><img src=https://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=https://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>How to TRIM your encrypted SSD in Fedora 19</h1><small role=doc-subtitle></small><p class=post-date>November 14, 2013</p><ul class=post-tags><li class=post-tag><a href=https://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>Few months ago I installed Fedora 19 on my new laptop with Samsung SSD and
yesterday I found out TRIM is not enabled by default. I was installing using
standard options with LVM/LUKS/ext4 partitions.</p><p>There were some problems in Fedora 18 with LUKS not propagating TRIM commands,
but this was fixed in Fedora 19. On my system, TRIM commands propagate
successfully. One just needs to make few changes in the configuration. First
of all, we need to check if TRIM propagates for all partitions to the end
device:</p><pre><code>[lzap@lzapx ~]$ lsblk -D
NAME                                            DISC-ALN DISC-GRAN DISC-MAX DISC-ZERO
sda                                                    0      512B       2G         1
├─sda1                                                 0      512B       2G         1
└─sda2                                                 0      512B       2G         1
  ├─fedora_lzapx-root                                  0      512B       2G         1
  ├─fedora_lzapx-swap                                  0      512B       2G         1
  └─fedora_lzapx-home                                  0      512B       2G         1
    └─luks-aaaaaaaa-6657-44f4-8297-bbbbbbbb1111        0      512B       2G         0
</code></pre><p>The last column shows if TRIM commands do propagate. We can see all is set,
<em>except</em> the encrypted home (the last line). To get full TRIM support on
LUKS-encrypted devices, we need to allow TRIM commands. Note that <em>this can
decrease encryption strengh</em>. This is the Fedora 19 default crypttab file:</p><pre><code>$ cat /etc/crypttab
luks-aaaaaaaa-6657-44f4-8297-bbbbbbbb1111 UUID=aaaaaaaa-6657-44f4-8297-a571e02e5492 none
</code></pre><p>I added <code>discard</code> (used to be <code>allow-discards</code> in older versions of Fedora - updated) option there:</p><pre><code>$ cat /etc/crypttab
luks-aaaaaaaa-6657-44f4-8297-bbbbbbbb1111 UUID=aaaaaaaa-6657-44f4-8297-a571e02e5492 none discard
</code></pre><p>After reboot, LUKS can be checked (for discards flag) with:</p><pre><code>[lzap@lzapx ~]$ sudo cryptsetup status luks-aaaaaaaa-6657-44f4-8297-bbbbbbbb1111
/dev/mapper/luks-aaaaaaaa-6657-44f4-8297-bbbbbbbb1111 is active and is in use.
  type:    LUKS1
  cipher:  aes-xts-plain64
  keysize: 512 bits
  device:  /dev/mapper/fedora_lzapx-home
  offset:  4096 sectors
  size:    370683904 sectors
  mode:    read/write
  flags:   discards
</code></pre><p>Note the <code>lsblk</code> command will still show zero for the LUKS partition (this is
normal). You should have the whole chain with <code>1</code> and <code>cryptsetup status</code>
should give you <code>discards</code>.</p><p>Before we get to the actual configuration, there are two optional steps you
can do.</p><h2 id=optional-lvm-configuration>Optional LVM configuration</h2><p>If you modify your LVM logical volumes often (e.g. shrinking, deleting), you
want to set issue_discards to 1 in <code>/etc/lvm/lvm.conf</code>. Then you need to do
the next optional step described bellow.</p><h2 id=optional-init-ram-disk-regeneration>Optional init RAM disk regeneration</h2><p>If you have <em>root</em> partition encrypted by LUKS (not my case) or if you have
your <em>root</em> partition on LVM <em>and</em> you want LVM trimming when shrinking or
deleting (see above optional step), initial RAM disk needs to be regenerated
using the following command:</p><pre><code>dracut -f
</code></pre><p>You will need to reboot to make this change effective of course.</p><p>Now, to enable TRIM and take advantage of it, there are two options:</p><h2 id=trim-when-deleting-files>TRIM when deleting files</h2><p>It is possible to configure ext4 to send TRIM commands while deleting data.
You can do this by adding <code>discard</code> option to partitions in <code>/etc/fstab</code>. Note
that this slows down deleting a bit. It depends on the SSD drive, but this can
slow down quite significantly on some drives.</p><p>Do not put <code>discard</code> option to swap devices as this is not required (and
perhaps it will not work either). Swap is SSD friendly by default and
propagates TRIM command.</p><h2 id=trim-via-systemd-service>TRIM via systemd service</h2><p>Preferred option for those who do not want to play around with anything and
want to discard later (when computer is at idle). To enable this option, do
this:</p><pre><code>systemctl enable fstrim.timer
systemctl start fstrim.timer
</code></pre><p>This timer was not enabled on my system by default, but I am upgrading my
Fedora twice an year and I can&rsquo;t tell if this is the same for new
installations.</p><h2 id=trim-from-cron>TRIM from cron</h2><p>This is my preferred option because it can be scheduled daily, weekly or
during night if you do not turn off your laptop/server:</p><pre><code>cat /etc/cron.weekly/01-fstrim
#!/bin/sh
fstrim /
fstrim /home

chmod +x /etc/cron.weekly/01-fstrim
</code></pre><p>Try to run the script now, it should not print any error message. If you
changed LUKS configuration, you might need restart before doing that. If you
delete lots of files often, consider scheduling trimming every day or even
every hour. The more you trim, the faster the process should be.</p><p>That&rsquo;s all folks. I would like to thank Lukáš Czerner, Kamil Páral and Chris
Smart for helping me with this.</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>