<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Peek into your Ruby app with SystemTap</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,ruby,rails,systemtap"><meta property="og:url" content="https://blog.zapletalovi.com/posts/2012-02-02-peek-into-your-ruby-app-with-systemtap/"><meta property="og:type" content="website"><meta property="og:title" content="Peek into your Ruby app with SystemTap"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Peek into your Ruby app with SystemTap"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="https://blog.zapletalovi.com/posts/2012-02-02-peek-into-your-ruby-app-with-systemtap/"><meta property="twitter:url" content="https://blog.zapletalovi.com/posts/2012-02-02-peek-into-your-ruby-app-with-systemtap/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=https://blog.zapletalovi.com/posts/2012-02-02-peek-into-your-ruby-app-with-systemtap/><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=https://blog.zapletalovi.com/css/dark.css><script src=https://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=https://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=https://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.zapletalovi.com><img src=https://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=https://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Peek into your Ruby app with SystemTap</h1><small role=doc-subtitle></small><p class=post-date>February 2, 2012</p><ul class=post-tags><li class=post-tag><a href=https://blog.zapletalovi.com/tags/ruby>ruby</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/rails>rails</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/systemtap>systemtap</a></li></ul></div><div class=post-content><p>I already <a href=/2012/01/probing-ruby-apps-with-systemtap-in.html>wrote</a> about using SystemTap with Ruby. Today I want to extend the last example I linked at the very end of my article. It's a nice example script of Ruby "top" utility.<br><br>Today I was investigating our <a href=http://www.katello.org>Katello</a> unit test codebase. We have over 1600 examples and the number is rising every day. The whole run is about seven minutes long. The utility gives very nice first look on the app showing the top Ruby calls. But there is one issue - it covers and shows lot of code. The output is unfiltered. But wait, there is the SystemTap!<br><br>I was interested only in files that are in /usr/share/katello directory structure. Well, easy help. One simple if-statement and we only see what we want.<br><br><pre>cat ./trace-ruby-rails.stp<br>#!/usr/bin/stap <br><br>global fn_calls;<br><br>probe ruby.function.entry<br>{ <br>  if (isinstr(file, "katello")) fn_calls[pid(), file, methodname, line] <<< 1;<br>}<br><br>probe timer.ms(4000) {<br>    ansi_clear_screen()<br>    printf("%6s %80s %6s %25s %6s\n",<br>           "PID", "FILENAME", "LINE", "FUNCTION", "CALLS")<br>    foreach ([pid, filename, funcname, lineno] in fn_calls- limit 15) {<br>        printf("%6d %80s %6d %25s %6d\n",<br>            pid, filename, lineno, funcname,<br>            @count(fn_calls[pid, filename, funcname, lineno]));<br>    }<br><br>    delete fn_calls;<br>}</pre>Before you run this, make sure you make your terminal wide enough. Also I highly recommend to set MAXMAPENTRIES value which defaults to 2k which is not enough and you can run into problems. It's a simple:<pre>stap -DMAXMAPENTRIES=10240 ./trace-ruby-rails.stp</pre>After I optimized our codebase I concentrated on Rails stack. Changing one lines shows you top calls from "active*" gems:<pre>...<br>  if (isinstr(file, "/active")) fn_calls[pid(), file, methodname, line] <<< 1;<br>...</pre>By the way with some help of Ivan Nečas we have found <a href="http://git.fedorahosted.org/git/?p=katello.git;a=commitdiff;h=0f46aabf51bcc4334b5b033eef5a8e15d1a0cb29">three</a> <a href="http://git.fedorahosted.org/git/?p=katello.git;a=commitdiff;h=3c7e99ffc7a75a6f400fa3a0c5ed30d85176fc3f">small</a> <a href="http://git.fedorahosted.org/git/?p=katello.git;a=commitdiff;h=d02643ae962407ab4354f1de6a2d2a1813baecdf">issues</a> which gave us 25 % boost. Not bad? I think I love SystemTap.</p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>