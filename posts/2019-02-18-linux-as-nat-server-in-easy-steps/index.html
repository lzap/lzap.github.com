<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Linux as NAT server in two easy steps</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2019-02-18-linux-as-nat-server-in-easy-steps/"><meta property="og:type" content="website"><meta property="og:title" content="Linux as NAT server in two easy steps"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Linux as NAT server in two easy steps"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2019-02-18-linux-as-nat-server-in-easy-steps/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2019-02-18-linux-as-nat-server-in-easy-steps/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2019-02-18-linux-as-nat-server-in-easy-steps/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Linux as NAT server in two easy steps</h1><small role=doc-subtitle></small><p class=post-date>February 18, 2019</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>There are many articles explaining how to do NAT and masquerading with Linux
using iptables or other quite low-level tools. This is all not necessary these
days, NetworkManager and firewalld can do the dirty work for us! If you have
RHEL7, CentOS7 or any modern Fedora or pretty much anything which is more
recent, it&rsquo;s super easy.</p><p>In my scenario I want to NAT traffic from an internal network 192.168.199.0/24
to external (virtual NAT actually) network 192.168.122.0/24. My host has two
NICs eth0 and eth1 connected to these networks in this order. Kernel has
forwarding turned off (the default setting for Red Hats):</p><pre><code># sysctl -a | grep ip_forward
net.ipv4.ip_forward = 0
</code></pre><p>It&rsquo;s really easy! Both my interfaces are in the public zone:</p><pre><code># firewall-cmd --get-active-zone
public
  interfaces: eth1 eth0
</code></pre><p>All I need to is to move them into pre-defined zones internal and external.</p><pre><code># nmcli c mod eth0 connection.zone internal
# nmcli c mod eth1 connection.zone external
</code></pre><p>You can stop reading now, Linux has been configured as NAT with masquarade now
with the stwo simple commands. Anyway, let&rsquo;s do some analysis. Look, firewalld
noticed I want to do NAT and enabled IP forwarding in the kernel for me.</p><pre><code># sysctl -a | grep ip_forward
net.ipv4.ip_forward = 1
</code></pre><p>Masquerade is already enabled on the pre-defined zone called external, again no
need to do anything here. Look:</p><pre><code># firewall-cmd --zone=external --query-masquerade
yes
</code></pre><p>The external pre-defined zone is quite strict similarly to public zone, only
ssh service is allowed. In my case I wanted to allow HTTP(s) traffic as well:</p><pre><code># firewall-cmd --zone=external --add-service=http
success
# firewall-cmd --zone=external --add-service=http --permanent
success
</code></pre><p>It&rsquo;s worth noting that internal pre-defined zone is also quite strict.
Remember, 70 per-cent of all security attacks come from the inside! Since I am
performing just some testing in isolated environment, I can afford to open it
up completely as I plan to run some extra services like DHCP, DNS and TFTP on
that server.</p><pre><code># firewall-cmd --list-all --zone=internal
internal (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0
  sources:
  services: ssh mdns samba-client dhcpv6-client
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
</code></pre><p>So I gave it the accept target policy. Do not try at home, this is dangerous!</p><pre><code># firewall-cmd --permanent --zone=internal --set-target=ACCEPT
success
# systemctl restart firewalld
</code></pre><p>Have fun!</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>