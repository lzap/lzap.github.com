<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Messing with CentOS 8 kickstart in libvirt</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2020-01-23-messing-with-centos-8-kickstart-in-libvirt/"><meta property="og:type" content="website"><meta property="og:title" content="Messing with CentOS 8 kickstart in libvirt"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Messing with CentOS 8 kickstart in libvirt"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2020-01-23-messing-with-centos-8-kickstart-in-libvirt/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2020-01-23-messing-with-centos-8-kickstart-in-libvirt/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2020-01-23-messing-with-centos-8-kickstart-in-libvirt/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Messing with CentOS 8 kickstart in libvirt</h1><small role=doc-subtitle></small><p class=post-date>January 23, 2020</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>Today, I was learning some practical details about Dracut, Anaconda and
NetworkManager. In short, the conclusion is we will stick with generating ifcfg
scripts in Foreman but I just wanted to share the command which I used to
quickly provision RHEL 8.0 to test generated networking configuration.</p><p>I created a kickstart script for RHEL 8 / CentOS 8 and published it over HTTP:</p><pre><code>text
network --device=enp1s0 --activate --bootproto=dhcp --noipv6 --hostname ks-test
firewall --enabled
url --url=&quot;http://mirror.centos.org/centos/8/BaseOS/x86_64/kickstart&quot;
rootpw --plaintext redhat
keyboard --xlayouts=us --vckeymap=us
lang en_US.UTF-8
selinux --enforcing
logging --level=info
timezone US/Eastern
reboot
bootloader --location=mbr
clearpart --all --initlabel
reqpart
part / --fstype=&quot;ext4&quot; --size=4000
%packages
@core
%end
</code></pre><p>Make sure to replace the CentOS URL with something close to you, or even your
own mirror which was my case. Then, to create a VM to play around with do:</p><pre><code>sudo virt-install --name ks-test \
  --vcpus 2 --ram 3500 \
  --disk path=/var/lib/libvirt/images/ks-test.qcow2,format=qcow2,size=8 \
  --os-variant rhel8.0 --graphics spice,listen=0.0.0.0 --noautoconsole \
  -l http://mirror.centos.org/centos/8/BaseOS/x86_64/kickstart \
  -x ks=http://www.example.com/kickstart.ks \
  -w network=default -w network=default -w network=default -w network=default
</code></pre><p>This one has four network cards all connected to &ldquo;default&rdquo; libvirt NAT network.
Note the <a href=https://www.example.com>www.example.com</a> host is serving the kickstart I&rsquo;ve shown above. That&rsquo;s
all, hope it is useful.</p><p>Now, I was messing around with various networking setups:</p><pre><code>network --device=enp1s0 --activate --bootproto=dhcp --noipv6 --hostname ks-test
network --device=enp2s0 --nodefroute --noipv4 --ipv6 fd00:aaaa:bbbb:cc::1 --vlanid 13 --interfacename=avlan13
network --device=enp3s0 --noipv4 --noipv6
network --device=enp4s0 --noipv4 --noipv6
network --device=bond0 --nodefroute --noipv4 --ipv6 fd00:aaaa:bbbb:cc::2 --bondslaves enp3s0,enp4s0 --bondopts=mode=active-backup,balance-rr;primary=enp3s0 --vlanid 13 --interfacename=bvlan13
</code></pre><p>I have found that it&rsquo;s much better to stick with generating ifcfg scripts
ourselves in %post section. Although most of the limitations were solved in
RHEL 7 and higher (VLAN, bond, team, bridge can be configured) some interfaces
(slaves specifically) are being initialized by dracut and this would need to be
workarounded. In the end, Dracut and Anaconda writes ifcfg files the same as we
do, so there is no reason to do it this way. Also, ifcfg can be theoretically
reused on other distibutions granted these were made for Red Hat configuration
backward compatibility.</p><p>In the future, if we want to move to more consistent network generation, native
NetworkManager ini files is probably way to go because <code>nmcli</code> command cannot
be used in <code>%post</code> section in kickstart (NetworkManager is not running in the
installed OS chroot). Alternatively, a man-in-middle could be used like Ansible
or Netplan.</p><p>Until next time!</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>