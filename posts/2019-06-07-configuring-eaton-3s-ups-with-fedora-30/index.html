<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Configuring Eaton 3S UPS with Fedora 30</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="https://blog.zapletalovi.com/posts/2019-06-07-configuring-eaton-3s-ups-with-fedora-30/"><meta property="og:type" content="website"><meta property="og:title" content="Configuring Eaton 3S UPS with Fedora 30"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Configuring Eaton 3S UPS with Fedora 30"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="https://blog.zapletalovi.com/posts/2019-06-07-configuring-eaton-3s-ups-with-fedora-30/"><meta property="twitter:url" content="https://blog.zapletalovi.com/posts/2019-06-07-configuring-eaton-3s-ups-with-fedora-30/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=https://blog.zapletalovi.com/posts/2019-06-07-configuring-eaton-3s-ups-with-fedora-30/><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=https://blog.zapletalovi.com/css/dark.css><script src=https://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=https://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=https://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.zapletalovi.com><img src=https://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=https://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=https://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=https://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=https://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Configuring Eaton 3S UPS with Fedora 30</h1><small role=doc-subtitle></small><p class=post-date>June 7, 2019</p><ul class=post-tags><li class=post-tag><a href=https://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=https://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>First off, make sure your UPS is connected. On my system, I had to use a
different USB port as it was disconnecting regularly for some reason - probably
USB power issues which is funny since this is a power device:</p><pre><code># dmesg
# lsusb
</code></pre><p>Install and configure nut software:</p><pre><code># dnf -y install nut

# grep ^MODE /etc/ups/nut.conf
MODE=standalone

# grep -v '^#' /etc/ups/ups.conf
[eaton3s]
driver=usbhid-ups
port=auto

# grep -v '^#' /etc/ups/upsmon.conf | egrep -v '^$'
MONITOR eaton3s@localhost 1 monuser pass master
MINSUPPLIES 1
SHUTDOWNCMD &quot;/sbin/shutdown -h +0&quot;
POLLFREQ 5
POLLFREQALERT 5
HOSTSYNC 15
DEADTIME 15
POWERDOWNFLAG /etc/killpower
NOTIFYFLAG ONBATT SYSLOG+WALL+EXEC
NOTIFYFLAG ONLINE SYSLOG+WALL+EXEC
NOTIFYCMD &quot;/etc/ups/shutdown-script&quot;
RBWARNTIME 43200
NOCOMMWARNTIME 300
FINALDELAY 5

# grep -v '^#' /etc/ups/upsd.users | egrep -v '^$'
[monuser]
password=pass
upsmon master
</code></pre><p>At this point, UPS should respond via USB which you can check with:</p><pre><code># usbhid-ups -DDD -a eaton3s
</code></pre><p>Make sure to replace &ldquo;pass&rdquo; with some password in both files. Now, the power
outage script is where you can implement what you want. In my case, I want to
see desktop notification every 10 seconds and after 3 minutes I want my system
to poweroff:</p><pre><code># cat /etc/ups/shutdown-script
#!/bin/bash
PATH=/sbin:/usr/sbin:/bin:/usr/bin:/usr/local/sbin:/usr/local/bin

trap &quot;exit 0&quot; SIGTERM

notify() {
        notify-send -u $2 &quot;$0: $1&quot;
}

if [ &quot;$NOTIFYTYPE&quot; = &quot;ONLINE&quot; ]; then
        notify &quot;power restored&quot; critical
        killall -s SIGTERM `basename $0`
fi

if [ &quot;$NOTIFYTYPE&quot; = &quot;ONBATT&quot; ]; then
        notify &quot;3 minutes until shutdown&quot; critical
        let &quot;n = 18&quot;
        while [ $n -ne 0 ]
        do
                sleep 10
                let &quot;n--&quot;
                notify &quot;$(( $n * 10 )) seconds until to shutdown&quot; low
        done
        notify &quot;commencing shutdown&quot; critical
        upsmon -c fsd
fi
</code></pre><p>On server systems, you want to replace notify-send with probably something like
<code>echo $0: $1 | wall</code> to notify console users. Make sure the script is
executable:</p><pre><code># chmod +x /etc/ups/shutdown-script
</code></pre><p>Start the services, note that one of the three services (nut-driver) is started
automatically as a dependency so do not enable it (systemd would complain
anyway):</p><pre><code># systemctl start nut-monitor nut-server
# systemctl enable nut-driver nut-monitor nut-server
# systemctl status nut-driver nut-monitor nut-server
</code></pre><p>To diplay battery remaining capacity and other details you can use this command line tool:</p><pre><code># upsc eaton3s
Init SSL without certificate database
battery.charge: 96
battery.charge.low: 20
battery.runtime: 672
battery.type: PbAc
device.mfr: EATON
device.model: Eaton 3S 550
device.serial: 000000000
device.type: ups
driver.name: usbhid-ups
driver.parameter.pollfreq: 30
driver.parameter.pollinterval: 2
driver.parameter.port: auto
driver.parameter.synchronous: no
driver.version: 2.7.4
driver.version.data: MGE HID 1.39
driver.version.internal: 0.41
input.transfer.high: 264
input.transfer.low: 184
outlet.1.desc: PowerShare Outlet 1
outlet.1.id: 2
outlet.1.status: on
outlet.1.switchable: yes
outlet.2.desc: PowerShare Outlet 2
outlet.2.id: 3
outlet.2.status: off
outlet.2.switchable: yes
outlet.desc: Main Outlet
outlet.id: 1
outlet.switchable: no
output.frequency.nominal: 50
output.voltage: 230.0
output.voltage.nominal: 230
ups.beeper.status: enabled
ups.delay.shutdown: 20
ups.delay.start: 30
ups.firmware: 02
ups.load: 30
ups.mfr: EATON
ups.model: Eaton 3S 550
ups.power.nominal: 550
ups.productid: ffff
ups.serial: 000000000
ups.status: OL
ups.timer.shutdown: 0
ups.timer.start: 0
ups.vendorid: 0463
</code></pre><p>Interesting parameters which are worth putting onto my i3status bar are
probably battery.* and ups.load. Remember to perform a test! A good one is
checking if this command works fine:</p><pre><code># upsmon -c fsd
</code></pre><p>And then full &ldquo;integration&rdquo; test - exit all programs and then pull the wire off the wall and wait :-)</p><p>Good luck!</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>