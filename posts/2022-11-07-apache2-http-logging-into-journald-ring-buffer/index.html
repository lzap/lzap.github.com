<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Apache2 http logging into journald ring buffer</title><meta name=description content="engineer in pyjama"><meta name=keywords content="blog,lzap,lukáš,zapletal,linux,tech,fedora"><meta property="og:url" content="http://blog.zapletalovi.com/posts/2022-11-07-apache2-http-logging-into-journald-ring-buffer/"><meta property="og:type" content="website"><meta property="og:title" content="Apache2 http logging into journald ring buffer"><meta property="og:description" content="engineer in pyjama"><meta property="og:image" content="/images/avatar_rh_512.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Apache2 http logging into journald ring buffer"><meta name=twitter:description content="engineer in pyjama"><meta property="twitter:domain" content="http://blog.zapletalovi.com/posts/2022-11-07-apache2-http-logging-into-journald-ring-buffer/"><meta property="twitter:url" content="http://blog.zapletalovi.com/posts/2022-11-07-apache2-http-logging-into-journald-ring-buffer/"><meta name=twitter:image content="/images/avatar_rh_512.jpg"><link rel=canonical href=http://blog.zapletalovi.com/posts/2022-11-07-apache2-http-logging-into-journald-ring-buffer/><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://blog.zapletalovi.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=http://blog.zapletalovi.com/css/dark.css><script src=http://blog.zapletalovi.com/js/svg-injector.min.js></script>
<script src=http://blog.zapletalovi.com/js/feather-icons.min.js></script>
<script src=http://blog.zapletalovi.com/js/main.js></script>
<script type=text/javascript>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-16034952-1"]),_gaq.push(["_trackPageview"]),function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}()</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://blog.zapletalovi.com><img src=http://blog.zapletalovi.com/images/avatar_rh_512.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://blog.zapletalovi.com>Lukáš Zapletal</a></div><div class=nav-links><div class=nav-link><a href=http://blog.zapletalovi.com/posts/>Posts</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/me/>About me</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/contact/>Contact</a></div><div class=nav-link><a href=http://blog.zapletalovi.com/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/lzap><span data-feather=github></span></a></div><div class=nav-link><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></div><div class=nav-link><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></div><div class=nav-link><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></div><div class=nav-link><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://blog.zapletalovi.com/posts/>Posts</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/me/>About me</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/contact/>Contact</a></li><li class=nav-item><a href=http://blog.zapletalovi.com/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/lzap><span data-feather=github></span></a></li><li class=nav-item><a href=https://mastodon.social/@lzap><img class=svg-inject src=/svg/icons/mastodon.svg></a></li><li class=nav-item><a href=https://twitter.com/lzap><span data-feather=twitter></span></a></li><li class=nav-item><a href=https://www.buymeacoffee.com/lzap><span data-feather=coffee></span></a></li><li class=nav-item><a href=http://blog.zapletalovi.com/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Apache2 http logging into journald ring buffer</h1><small role=doc-subtitle></small><p class=post-date>November 7, 2022</p><ul class=post-tags><li class=post-tag><a href=http://blog.zapletalovi.com/tags/linux>linux</a></li><li class=post-tag><a href=http://blog.zapletalovi.com/tags/fedora>fedora</a></li></ul></div><div class=post-content><p><p>My webserver at home has several services including Mastodon. And I use Apache2
for web content and as a reverse web proxy, however, this system is configured
to log all hits in <code>/var/log/httpd</code>. Both disks in my server are SSD and I
do not want to let it to rotate hundreds of megabytes of access logs every
week full of bots trying to find security hole in wordpress or other
known software (which is not even running on my site).</p><p>To solve this, you can configure Apache2 httpd to log into systemd journald
which can be configured in volatile mode. This is essentially a ring buffer
that consumes some memory and never writes anything to disk keeping my SSD wear
leveling at a reasonable level. To do this simply turn journal into volatile
mode, turn off rate limiting and set amount of memory you want to dedicate for
the journal:</p><pre><code>    [Journal]
    Storage=volatile
    RateLimitIntervalSec=0
    RateLimitBurst=0
    RuntimeMaxUse=10M
</code></pre><p>Warning: If you run any kind of public service, check with legal before you do
this. Some limitations may apply depending on where you live or the server is
located in regard to data retention.</p><p>Although Apache2 httpd 2.5+ had <a href=https://httpd.apache.org/docs/trunk/mod/mod_journald.html>dedicated
module</a> for writing
to the system journal, this is not even in Fedora yet. The workaround is simple</p><ul><li><p>to use piped command which logs into the journal. In this mode, httpd spawns
a process and logs into its standard input. The program we can use ships with
systemd: <code>logger</code>:</p><pre><code>  # cat /etc/httpd/conf/httpd.conf
  ...
  LogFormat &quot;%h \&quot;%r\&quot; %&gt;s %b&quot; journal
  CustomLog &quot;|/usr/bin/logger -t httpd -p local7.info&quot; journal
  ...
</code></pre></li></ul><p>Do the same for <code>ssl.conf</code> file which has configuration for TLS. You can use
the &ldquo;common&rdquo; log format, but in that case you will see date and time twice, so
I ended up creating more simple format that looks like this:</p><pre><code>    # journalctl -f
    Nov 07 14:13:53 nuc.home.lan httpd[225124]: 162.19.29.212 &quot;POST /users/lukas/inbox HTTP/1.1&quot; 401 23
</code></pre><p>That&rsquo;s all for today. Cheers.</p></p></div></div></main><footer class=footer><span>&copy; 2022 Lukáš Zapletal, CC BY 4.0</span>
<span>Built with <a href=https://gohugo.io>hugo</a>, template <a target=_blank href=https://github.com/526avijitgupta/gokarna>gokarna</a></span></footer></body></html>